<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<link
	href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css"
	rel="stylesheet"
/>
<script
	src="https://unpkg.com/quill-table-ui@1.0.5/dist/umd/index.js"
	type="text/javascript"
></script>
<link
	href="https://unpkg.com/quill-table-ui@1.0.5/dist/index.css"
	rel="stylesheet"
/>
<!-- å†…å®¹å¯¼å‡ºç›¸å…³åº“ -->
<script src="https://unpkg.com/turndown/dist/turndown.js"></script>
<script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- æ·»åŠ  Font Awesome å›¾æ ‡åº“ -->
<link
	rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
<!-- Monaco Editor èµ„æºå¼•å…¥ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
<link rel="stylesheet" href="./style.css">
<body>
	<div class="editor-container">
		<div id="editor">
			<h2>Demo Content</h2>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
			<p>Preset build with snow theme, and some common formats.</p>
		</div>
	</div>

	<div class="floating-input" id="floatingInput" tabindex="0">
		<div class="input-container">
			<input type="text" id="promptInput" placeholder="è¾“å…¥æç¤º..." />
			<button class="send-btn" id="sendBtn">
				<i class="fas fa-paper-plane"></i>
				<span>å‘é€</span>
			</button>
		</div>
		<div class="ai-response" id="aiResponse">
			<div class="response-content"></div>
			<div class="action-buttons" id="actionButtons">
				<div class="left-buttons">
					<button id="insertAfter">
						<i class="fas fa-plus"></i>
						æ’å…¥åˆ°åé¢
					</button>
					<button id="replace">
						<i class="fas fa-exchange-alt"></i>
						æ›¿æ¢é€‰ä¸­å†…å®¹
					</button>
				</div>
				<div class="right-buttons">
					<button id="aiResponseRegenerateBtn">
						<i class="fas fa-sync-alt"></i>
						é‡æ–°ç”Ÿæˆ
					</button>
					<button id="aiResponseCopyBtn">
						<i class="fas fa-copy"></i>
						å¤åˆ¶
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ä¿®æ”¹å‚ç›´èœå•HTMLç»“æ„ -->
	<div class="vertical-menu" id="verticalMenu" tabindex="0">
		<div class="menu-item">ğŸ“ å•è¯è¯­æ³•çº é”™</div>
		<div class="menu-item">âœ¨ AIæ¶¦è‰²</div>
		<div class="menu-item">ğŸ“Š AIç¼©å†™</div>
		<div class="menu-item">ğŸ“ˆ AIæ‰©å†™</div>
		<div class="menu-item">ğŸ“‹ AIæ€»ç»“</div>
		<div class="menu-item">ğŸ‡¨ğŸ‡³ ç¿»è¯‘æˆä¸­æ–‡</div>
		<div class="menu-item">ğŸ‡¬ğŸ‡§ ç¿»è¯‘æˆè‹±æ–‡</div>
	</div>

	<!-- åœ¨ editor-container div åæ·»åŠ å¯¼å‡ºèœå• -->
	<div class="export-menu" id="exportMenu">
		<div class="export-menu-item" data-format="markdown">å¯¼å‡ºä¸º Markdown</div>
		<div class="export-menu-item" data-format="docx">å¯¼å‡ºä¸º Word</div>
		<div class="export-menu-item" data-format="pdf">å¯¼å‡ºä¸º PDF</div>
	</div>

	<!-- åœ¨ body æœ€åæ·»åŠ æµ‹è¯•æŒ‰é’® -->
	<button class="test-markdown-btn" onclick="testMarkdownRender()">
		æµ‹è¯• Markdown æ¸²æŸ“
	</button>

	<!-- åœ¨ body æœ«å°¾æ·»åŠ å¯¹æ¯”ç¼–è¾‘å™¨å®¹å™¨ -->
	<div id="diffContainer" style="display: none">
		<div id="diffWrapper">
			<div id="diffEditor"></div>
			<div class="diff-actions">
				<button id="confirmReplace" class="diff-btn confirm">ç¡®è®¤æ›¿æ¢</button>
				<button id="cancelReplace" class="diff-btn cancel">å–æ¶ˆ</button>
			</div>
		</div>
	</div>
</body>

<script>
	Quill.register("modules/tableUI", quillTableUI.default);

	const options = {
		// debug: "info",
		modules: {
			table: true,
			tableUI: true,
			toolbar: {
				container: [
					[{ header: [1, 2, 3, false] }],
					["bold", "italic", "underline"],
					[{ align: [] }],
					// ["code-block"],
					[{ list: "ordered" }, { list: "bullet" }],
					["table"], // æ·»åŠ è¡¨æ ¼æŒ‰é’®
					["export"], // ç»Ÿä¸€çš„å¯¼å‡ºæŒ‰é’®
					["copy-content"], // æ·»åŠ å¤åˆ¶æŒ‰é’®
					["undo", "redo"], // æ·»åŠ æ’¤é”€é‡åšæŒ‰é’®
				],
				handlers: {
					undo: function () {
						quill.history.undo();
					},
					redo: function () {
						quill.history.redo();
					},
					export: function (value) {
						showExportMenu();
					},
					table: function (value) {
						table.insertTable(3, 3);
					},
					"copy-content": function () {
						// æ·»åŠ å¤åˆ¶æŒ‰é’®çš„ handler
						copyContentToClipboardAsText();
					},
				},
			},
			history: {
				delay: 1000,
				maxStack: 500,
				//trueè¡¨ç¤ºåªæœ‰ç”¨æˆ·æ“ä½œæ‰ä¼šè¢«è®°å½•ï¼Œfalseè¡¨ç¤ºæ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«è®°å½•
				userOnly: false,
			},
		},

		placeholder: "Compose an epic...",
		theme: "snow",
	};
	const quill = new Quill("#editor", options);
	const table = quill.getModule("table");

	// ç”¨äºåˆ¤æ–­èœå•æ˜¯å¦é è¿‘åº•éƒ¨,åº•éƒ¨æ—¶å‘ä¸Šæ˜¾ç¤º
	let posCloseToBottom = false;
	let currentRange = null;

	const floatingInput = document.getElementById("floatingInput");
	const verticalMenu = document.getElementById("verticalMenu");
	const promptInput = document.getElementById("promptInput");
	const sendBtn = document.getElementById("sendBtn");
	const aiResponse = document.getElementById("aiResponse");
	const actionButtons = document.getElementById("actionButtons");

	// é€‰ä¸­å†…å®¹éƒ¨åˆ†çš„é«˜äº®å¤„ç†
	function highlightSelection(range) {
		if (range && range.length > 0) {
			quill.formatText(range.index, range.length, "background", "#b4d5fe");
		}
	}

	// ä¿®æ”¹ clearHighlight å‡½æ•°
	function clearHighlight() {
		if (currentRange) {
			const tempRange = currentRange;
			currentRange = null; // å…ˆé‡ç½® currentRange

			// ä½¿ç”¨ setTimeout ç¡®ä¿åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œæ ¼å¼æ¸…é™¤
			setTimeout(() => {
				quill.formatText(
					tempRange.index,
					tempRange.length,
					"background",
					false,
					"api" // æŒ‡å®šæºä¸º api é¿å…è§¦å‘ text-change äº‹ä»¶å¤„ç†
				);
			}, 0);
		}
	}

	// è·å–å·¥å…·æ å®¹å™¨
	const toolbar = quill.getModule("toolbar").container;

	// åˆ›å»ºæ˜¾ç¤ºåˆ›å»ºæ—¶é—´çš„ span å…ƒç´ 
	const creationTimeDisplay = document.createElement("span");
	creationTimeDisplay.id = "creationTimeDisplay";
	creationTimeDisplay.classList.add("ql-creation-time"); // æ·»åŠ  CSS ç±»ï¼Œæ–¹ä¾¿æ ·å¼æ§åˆ¶
	toolbar.prepend(creationTimeDisplay); // å°†åˆ›å»ºæ—¶é—´æ˜¾ç¤ºå…ƒç´ æ·»åŠ åˆ°å·¥å…·æ çš„ *æœ€å‰é¢*

	// åˆ›å»ºæ˜¾ç¤ºå­—æ•°ç»Ÿè®¡çš„ span å…ƒç´ 
	const wordCountDisplay = document.createElement("span");
	wordCountDisplay.id = "wordCountDisplay";
	wordCountDisplay.classList.add("ql-word-count"); // æ·»åŠ  CSS ç±»ï¼Œæ–¹ä¾¿æ ·å¼æ§åˆ¶
	toolbar.prepend(wordCountDisplay); //  å°†å­—æ•°ç»Ÿè®¡æ˜¾ç¤ºå…ƒç´ æ·»åŠ åˆ°å·¥å…·æ çš„ *æœ€å‰é¢* (å®ƒä¼šåœ¨åˆ›å»ºæ—¶é—´å…ƒç´ çš„å³è¾¹ï¼Œå› ä¸ºæ˜¯ prepend)

	// è·å–å¹¶æ ¼å¼åŒ–å½“å‰æ—¶é—´
	function getCurrentTime() {
		const now = new Date();
		const hours = String(now.getHours()).padStart(2, "0");
		const minutes = String(now.getMinutes()).padStart(2, "0");
		const seconds = String(now.getSeconds()).padStart(2, "0");
		const day = String(now.getDate()).padStart(2, "0");
		const month = String(now.getMonth() + 1).padStart(2, "0"); // æœˆä»½ä» 0 å¼€å§‹
		const year = now.getFullYear();
		return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
	}

	// æ›´æ–°åˆ›å»ºæ—¶é—´æ˜¾ç¤º
	function updateCreationTimeDisplay() {
		const currentTime = getCurrentTime();
		creationTimeDisplay.textContent = `æœ€è¿‘ä¿®æ”¹: ${currentTime}`;
	}

	// è®¡ç®—å­—æ•°å¹¶æ›´æ–°æ˜¾ç¤º
	function updateWordCountDisplay() {
		const text = quill.getText(); // è·å–ç¼–è¾‘å™¨çº¯æ–‡æœ¬å†…å®¹
		const wordCount = text
			.replace(
				/[\u3002\uff01\uff0c\uff1a\uff1b\uff1f\u0021-\u002f\u003a-\u0040\u005b-\u0060\u007b-\u007e]/g,
				""
			) // ç§»é™¤æ ‡ç‚¹ç¬¦å·
			.replace(/\s+/g, "") // ç§»é™¤æ‰€æœ‰ç©ºæ ¼
			.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, "").length; // ç§»é™¤ç‰¹æ®Šç¬¦å· // ç›´æ¥è®¡ç®—å­—ç¬¦æ•°ï¼Œå³å­—æ•°
		wordCountDisplay.textContent = `å­—æ•°: ${wordCount}`;
	}

	// åˆå§‹åŒ–åˆ›å»ºæ—¶é—´æ˜¾ç¤º
	updateCreationTimeDisplay();
	// åˆå§‹åŒ–å­—æ•°ç»Ÿè®¡æ˜¾ç¤º
	updateWordCountDisplay();

	// ä¿®æ”¹ text-change äº‹ä»¶ç›‘å¬
	quill.on("text-change", function (delta, oldDelta, source) {
		if (source === "user") {
			// ä½¿ç”¨ setTimeout ç¡®ä¿åœ¨æ¸²æŸ“å®Œæˆåå†æ¸…é™¤é«˜äº®
			setTimeout(() => {
				console.log("text-changeçš„æ ·å¼é‡ç½®æ‰§è¡Œäº†");
				// æ¸…é™¤æ‰€æœ‰èƒŒæ™¯è‰²æ ·å¼
				const length = quill.getLength();
				quill.formatText(0, length, "background", false, "api");

				// é‡ç½®çŠ¶æ€å’Œéšè—ç•Œé¢å…ƒç´ 
				currentRange = null;
				floatingInput.style.display = "none";
				aiResponse.style.display = "none";
				verticalMenu.style.display = "none";
				actionButtons.style.display = "none";
				promptInput.value = "";
				posCloseToBottom = false;
			}, 0);
		}
		updateWordCountDisplay();
		updateCreationTimeDisplay();
		checkEmptyLine();
	});
	function copyContentToClipboardAsText() {
		const content = quill.getText(); // ä½¿ç”¨ getText() è·å–çº¯æ–‡æœ¬å†…å®¹
		navigator.clipboard
			.writeText(content)
			.then(() => {
				// alert("å¤åˆ¶æˆåŠŸ!"); // æç¤ºä¿¡æ¯ä¹Ÿç›¸åº”ä¿®æ”¹
			})
			.catch((err) => {
				console.error("å¤åˆ¶å†…å®¹å¤±è´¥: ", err);
				// alert("å¤åˆ¶å†…å®¹å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
			});
	}
	// æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
	quill.root.addEventListener("keydown", function (e) {
		if (e.key === "/") {
			const selection = quill.getSelection();
			if (!selection) return;

			const [line, offset] = quill.getLine(selection.index);
			const text = line.domNode.textContent;

			// æ£€æŸ¥æ˜¯å¦åœ¨ç©ºè¡Œ
			if (!text.trim()) {
				e.preventDefault(); // é˜»æ­¢/å­—ç¬¦çš„è¾“å…¥
				showAIMenu(line);
			}
		}
	});

	// æ·»åŠ ç©ºè¡Œæ£€æµ‹å‡½æ•°
	function checkEmptyLine() {
		const selection = quill.getSelection();
		if (!selection) return;

		const [line, offset] = quill.getLine(selection.index);
		const text = line.domNode.textContent;

		// å¦‚æœä¸æ˜¯ç©ºè¡Œï¼Œéšè—AIç›¸å…³UI
		if (text.trim()) {
			hideAIUI();
		}
	}

	// æ˜¾ç¤ºAIèœå•å‡½æ•°
	function showAIMenu(line) {
		const selection = quill.getSelection();
		console.log(selection);
		if (!selection) return;
		// åœ¨ç©ºè¡Œæƒ…å†µæ‰‹åŠ¨è®¾ç½® currentRange
		currentRange = { index: selection.index, length: selection.length };
		const bounds = quill.getBounds(quill.getSelection().index);
		const editorRect = quill.container.getBoundingClientRect();
		const editorContentRect = quill.root.getBoundingClientRect();

		// è®¾ç½®æµ®åŠ¨è¾“å…¥æ¡†å’Œå‚ç›´èœå•çš„ä½ç½®
		floatingInput.style.display = "block";
		verticalMenu.style.display = "block";

		const leftPosition = editorContentRect.left;
		const topPosition = editorRect.top + bounds.bottom + 5;

		// ç»Ÿä¸€å·¦å¯¹é½
		[floatingInput, verticalMenu].forEach((element) => {
			element.style.left = `${leftPosition}px`;
			element.style.position = "fixed";
		});

		// è®¾ç½®å‚ç›´ä½ç½®
		floatingInput.style.top = `${topPosition}px`;
		verticalMenu.style.top = `${
			topPosition + floatingInput.offsetHeight + 5
		}px`;

		// ç›‘å¬ç‚¹å‡»äº‹ä»¶
		setTimeout(() => {
			document.addEventListener("click", handleOutsideClick);
		}, 0);
	}

	// éšè—AIç›¸å…³UIå‡½æ•°
	function hideAIUI() {
		floatingInput.style.display = "none";
		verticalMenu.style.display = "none";
		aiResponse.style.display = "none";
		actionButtons.style.display = "none";
		promptInput.value = "";
	}

	// å¤„ç†å¤–éƒ¨ç‚¹å‡»äº‹ä»¶
	function handleOutsideClick(event) {
		const isClickInside =
			floatingInput.contains(event.target) ||
			verticalMenu.contains(event.target) ||
			event.target.closest(".ql-editor");

		if (!isClickInside) {
			hideAIUI();
			document.removeEventListener("click", handleOutsideClick);
		}
	}

	/**
	 * å¤„ç† Quill ç¼–è¾‘å™¨ä¸­çš„é€‰æ‹©å˜åŒ–äº‹ä»¶
	 *
	 * @param {Object} range - å½“å‰é€‰æ‹©çš„èŒƒå›´å¯¹è±¡ï¼Œ{index, length}ã€‚
	 * @param {Object} oldRange - ä¹‹å‰çš„é€‰æ‹©èŒƒå›´å¯¹è±¡ã€‚
	 * @param {string} source - è§¦å‘é€‰æ‹©å˜åŒ–çš„æ¥æºï¼Œä¾‹å¦‚ 'user' æˆ– 'api'ã€‚
	 * é€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œåœ¨é€‰ä¸­æ–‡æœ¬æ—¶quillå†…éƒ¨emitå¯¹åº”çš„æ—¶é—´åçš„å›è°ƒ
	 */
	quill.on("selection-change", function (range, oldRange, source) {
		// console.log("ğŸš€ ~ range:", range);
		if (range && range.length > 0) {
			//é€‰ä¸­å†…å®¹åï¼Œç»§ç»­é€‰ä¸­æ–°çš„å†…å®¹æ—¶ï¼Œæ¸…é™¤ä¹‹å‰é€‰ä¸­å†…å®¹çš„é«˜äº®
			if (currentRange) clearHighlight();

			//getBounds() æ–¹æ³•ç”¨äºè·å–æ–‡æœ¬é€‰åŒºçš„ä½ç½®å’Œå°ºå¯¸ä¿¡æ¯,ç›¸å¯¹äºå·¦ä¸Šè§’åŸç‚¹
			const bounds = quill.getBounds(range.index, range.length);
			currentRange = range;

			// æ·»åŠ é«˜äº®
			highlightSelection(range);

			// è·å–ç¼–è¾‘å™¨å®¹å™¨çš„ä½ç½®ä¿¡æ¯
			const editorRect = quill.container.getBoundingClientRect();

			// è·å–ç¼–è¾‘å™¨çš„å®é™…å†…å®¹åŒºåŸŸå®½åº¦
			const editorContentRect = quill.root.getBoundingClientRect();
			const editorWidth = editorContentRect.width;

			// è®¾ç½®å…ƒç´ å®½åº¦ä¸ºå®é™…å†…å®¹åŒºåŸŸå®½åº¦
			[floatingInput, aiResponse].forEach((element) => {
				element.style.width = `${editorWidth - 20}px`;
			});
			// è®¡ç®—å·¦å¯¹é½ä½ç½®ï¼ˆä¸ç¼–è¾‘å™¨å†…å®¹å·¦è¾¹ç•Œå¯¹é½ï¼‰
			const leftPosition = editorContentRect.left;

			// å®šä¹‰ç»Ÿä¸€é—´è·
			const ELEMENT_SPACING = 5;

			// æ˜¾ç¤ºæ‰€æœ‰å…ƒç´ ä»¥è·å–æ­£ç¡®é«˜åº¦
			floatingInput.style.display = "block";
			verticalMenu.style.display = "block";
			aiResponse.style.display = "none";

			// è·å–æ‰€æœ‰å…ƒç´ é«˜åº¦
			const dimensions = {
				window: window.innerHeight,
				floatingInput: floatingInput.offsetHeight,
				verticalMenu: verticalMenu.offsetHeight,
			};

			// è®¡ç®—åŸºç¡€ä½ç½®
			let topPosition = editorRect.top + bounds.bottom + ELEMENT_SPACING;

			if (
				topPosition + dimensions.floatingInput + dimensions.verticalMenu >
				dimensions.window
			) {
				// å‘ä¸Šå¸ƒå±€æ¨¡å¼
				floatingInput.style.top = `${
					topPosition - dimensions.floatingInput - bounds.height - 10
				}px`;
				verticalMenu.style.top = `${
					topPosition -
					dimensions.floatingInput -
					bounds.height -
					dimensions.verticalMenu -
					13
				}px`;
			} else {
				posCloseToBottom = false;
				// å‘ä¸‹å¸ƒå±€æ¨¡å¼
				// ä»ä¸Šåˆ°ä¸‹å¸ƒå±€ï¼šè¾“å…¥æ¡† -> å‚ç›´èœå•
				floatingInput.style.top = `${topPosition}px`;
				verticalMenu.style.top = `${
					topPosition + dimensions.floatingInput + ELEMENT_SPACING
				}px`;
			}

			// ç»Ÿä¸€å·¦å¯¹é½
			[floatingInput, verticalMenu, aiResponse].forEach((element) => {
				element.style.left = `${leftPosition}px`;
				element.style.position = "fixed";
			});

			// è®¾ç½® AI å“åº”åŒºåŸŸçš„æ ·å¼ï¼Œå®ƒä¼šåœ¨éœ€è¦æ—¶æ˜¾ç¤º
			aiResponse.style.position = "fixed";
			aiResponse.style.left = `${leftPosition}px`;
		} else if (!range) {
			// console.log("ğŸš€ ~ !range:", !range);
			// ç‚¹å‡»ç¼–è¾‘å™¨å¤–éƒ¨æ—¶éšè—è¾“å…¥æ¡†ï¼Œä½†ç‚¹å‡»è¾“å…¥æ¡†æœ¬èº«æ—¶ä¸éšè—
			console.log(floatingInput.contains(document.activeElement));
			console.log(verticalMenu.contains(document.activeElement));
			if (
				!floatingInput.contains(document.activeElement) &&
				!verticalMenu.contains(document.activeElement)
			) {
				console.log("selection-changeéƒ¨åˆ†else ifçš„æ ·å¼é‡ç½®æ‰§è¡Œäº†");
				clearHighlight();
				floatingInput.style.display = "none";
				aiResponse.style.display = "none";
				const verticalMenu = document.getElementById("verticalMenu");
				verticalMenu.style.display = "none"; // éšè—èœå•
			}
		}
	});

	// å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	sendBtn.addEventListener("click", async () => {
		const prompt = promptInput.value;
		if (!prompt) return;
		console.log("å‘é€æŒ‰é’®ç‚¹å‡»äº†");
		// è·å–é€‰ä¸­çš„æ–‡æœ¬
		const selectedText = currentRange
			? quill.getText(currentRange.index, currentRange.length)
			: "";

		// æ˜¾ç¤ºAIå“åº”åŒºåŸŸ
		verticalMenu.style.display = "none";
		aiResponse.style.display = "block";
		const responseContent = aiResponse.querySelector(".response-content");
		const copyBtn = document.getElementById("aiResponseCopyBtn");
		const regenerateBtn = document.getElementById("aiResponseRegenerateBtn");

		// åœ¨ç”Ÿæˆå›ç­”æ—¶éšè—æŒ‰é’®ç»„
		actionButtons.style.display = "none";
		responseContent.textContent = "æ­£åœ¨ç”Ÿæˆå›ç­”...";

		// è®¾ç½® AI å“åº”ä½ç½®åœ¨è¾“å…¥æ¡†ä¸‹æ–¹
		const inputRect = floatingInput.getBoundingClientRect();
		aiResponse.style.top = `${inputRect.bottom - 5}px`; // 5px é—´è·

		// æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
		setTimeout(() => {
			responseContent.textContent = `é€‰ä¸­çš„æ–‡æœ¬æ˜¯ï¼š${selectedText}\nAIçš„å›ç­”ï¼š${prompt}`;
			actionButtons.style.display = "flex"; // æ˜¾ç¤ºæ•´ä¸ªæŒ‰é’®ç»„
		}, 1000);
	});

	// ä¿®æ”¹å†…å®¹æ’å…¥å‡½æ•°
	function insertContent(text, startIndex, isReplace = false) {
		// ä½¿ç”¨ replacementRange è€Œä¸æ˜¯ currentRange
		if (isReplace && replacementRange) {
			quill.deleteText(replacementRange.index, replacementRange.length);
			quill.insertText(replacementRange.index, text);
		} else {
			quill.insertText(startIndex, text);
		}
	}

	// ä¿®æ”¹æ’å…¥å†…å®¹çš„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	document.getElementById("insertAfter").addEventListener("click", () => {
		// ä½¿ç”¨ currentRangeï¼Œå› ä¸ºè¿™ä¸ªæ“ä½œä¸éœ€è¦ä¿å­˜èŒƒå›´
		if (currentRange) {
			const responseContent = aiResponse.querySelector(".response-content");
			if (responseContent) {
				const fullText = responseContent.textContent;
				const aiResponsePart = fullText.split("AIçš„å›ç­”ï¼š")[1];

				if (aiResponsePart) {
					const insertIndex = currentRange.index + currentRange.length;
					// åœ¨é€‰ä¸­å†…å®¹åé¢æ’å…¥ï¼Œæ·»åŠ ä¸€ä¸ªç©ºæ ¼å’Œå¤„ç†åçš„ AI å“åº”
					insertContent(" " + aiResponsePart.trim(), insertIndex, false);

					aiResponse.style.display = "none";
					floatingInput.style.display = "none";
					actionButtons.style.display = "none";
				}
			}
		}
		const length = quill.getLength();
		quill.formatText(0, length, "background", false, "api");
	});

	// æ·»åŠ ä¸€ä¸ªå˜é‡æ¥ä¿å­˜è¦æ›¿æ¢çš„èŒƒå›´ä¿¡æ¯
	let replacementRange = null;

	// ä¿®æ”¹ showDiffEditor å‡½æ•°ï¼Œä¿å­˜æ›¿æ¢èŒƒå›´
	function showDiffEditor(originalText, modifiedText) {
		// ä¿å­˜å½“å‰èŒƒå›´ç”¨äºåç»­æ›¿æ¢
		if (currentRange) {
			replacementRange = { ...currentRange };
		} else {
			console.error("No selection range available");
			return;
		}

		const container = document.getElementById("diffContainer");
		const editorElement = document.getElementById("diffEditor");
		container.style.display = "flex";

		// å¦‚æœç¼–è¾‘å™¨å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯å®ƒ
		if (diffEditor) {
			diffEditor.dispose();
			diffEditor = null;
		}

		// åˆ›å»ºæ–°çš„å¯¹æ¯”ç¼–è¾‘å™¨å®ä¾‹ï¼Œè®¾ç½®å³ä¾§å¯ç¼–è¾‘
		diffEditor = monaco.editor.createDiffEditor(editorElement, {
			automaticLayout: true,
			readOnly: false, // å…è®¸ç¼–è¾‘
			theme: "vs-dark",
			renderSideBySide: true,
			scrollBeyondLastLine: false,
			minimap: {
				enabled: false,
			},
			originalEditable: false, // å·¦ä¾§åŸæ–‡ä¸å¯ç¼–è¾‘
			modifiedEditable: true, // å³ä¾§æ–°å†…å®¹å¯ç¼–è¾‘
		});

		// åˆ›å»ºåŸå§‹æ–‡æœ¬å’Œä¿®æ”¹åæ–‡æœ¬çš„æ¨¡å‹
		const originalModel = monaco.editor.createModel(originalText, "text/plain");
		const modifiedModel = monaco.editor.createModel(
			modifiedText,
			"text/plain",
			monaco.Uri.parse("modified.txt")
		); // ç»™ä¿®æ”¹åçš„æ–‡æœ¬ä¸€ä¸ªå”¯ä¸€çš„ URI

		// è®¾ç½®æ¨¡å‹
		diffEditor.setModel({
			original: originalModel,
			modified: modifiedModel,
		});

		// è®¾ç½®ä¿®æ”¹åå†…å®¹çš„ç¼–è¾‘å™¨çš„ä¸€äº›ç‰¹å®šé…ç½®
		const modifiedEditor = diffEditor.getModifiedEditor();
		modifiedEditor.updateOptions({
			readOnly: false,
			// æ·»åŠ ä¸€äº›ç¼–è¾‘å‹å¥½çš„é…ç½®
			lineNumbers: "on",
			wordWrap: "on",
			scrollBeyondLastLine: false,
			minimap: { enabled: false },
			folding: true,
			fontSize: 14,
			lineHeight: 20,
			suggestOnTriggerCharacters: false, // ç¦ç”¨è‡ªåŠ¨è¡¥å…¨
		});

		// èšç„¦åˆ°å¯ç¼–è¾‘åŒºåŸŸ
		setTimeout(() => {
			modifiedEditor.focus();
		}, 100);
	}

	// ä¿®æ”¹ç¡®è®¤æ›¿æ¢æŒ‰é’®äº‹ä»¶
	document.getElementById("confirmReplace").addEventListener("click", () => {
		if (!diffEditor || !replacementRange) {
			console.error("No diff editor or replacement range available");
			return;
		}

		const modifiedText = diffEditor.getModifiedEditor().getValue();

		// ä½¿ç”¨ä¿å­˜çš„èŒƒå›´è¿›è¡Œæ›¿æ¢
		insertContent(modifiedText, replacementRange.index, true);

		// æ¸…ç†çŠ¶æ€
		clearHighlight();
		closeDiffEditor();
	});

	// ä¿®æ”¹å…³é—­å¯¹æ¯”ç¼–è¾‘å™¨å‡½æ•°
	function closeDiffEditor() {
		const container = document.getElementById("diffContainer");
		container.style.display = "none";

		if (diffEditor) {
			try {
				const models = diffEditor.getModel();
				if (models) {
					if (models.original) models.original.dispose();
					if (models.modified) models.modified.dispose();
				}
				diffEditor.dispose();
			} catch (error) {
				console.error("Error disposing editor:", error);
			}
			diffEditor = null;
		}

		// é‡ç½®æ›¿æ¢èŒƒå›´
		replacementRange = null;
	}

	// ç§»é™¤åŸæœ‰çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œæ”¹ç”¨æ–°çš„é€»è¾‘
	document.addEventListener("mouseup", (event) => {
		// å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿selection-changeäº‹ä»¶å…ˆè§¦å‘
		setTimeout(() => {
			const target = event.target;
			const verticalMenu = document.getElementById("verticalMenu");
			const isInVerticalMenu = verticalMenu.contains(target);
			if (verticalMenu.contains(target)) return;
			// æ£€æŸ¥ç‚¹å‡»ç›®æ ‡æ˜¯å¦åœ¨å…è®¸çš„åŒºåŸŸå†…
			const isInFloatingInput = floatingInput.contains(target);
			const isInEditor = quill.container.contains(target);
			const hasSelection =
				quill.getSelection() && quill.getSelection().length > 0;

			// å¦‚æœç‚¹å‡»åœ¨å…è®¸åŒºåŸŸå¤–ï¼Œä¸”ä¸æ˜¯åœ¨é€‰æ‹©æ–‡æœ¬
			if (!isInFloatingInput && !hasSelection && !isInVerticalMenu) {
				console.log("selection-changeçš„æ ·å¼æ¸…é™¤è§¦å‘äº†");
				floatingInput.style.display = "none";
				aiResponse.style.display = "none";
				actionButtons.style.display = "none";
				verticalMenu.style.display = "none"; // éšè—èœå•
				promptInput.value = "";
				clearHighlight(); // æ¸…é™¤é«˜äº®
				posCloseToBottom = false;
			}
		}, 0);
	});

	// é€‰ä¸­åçš„aièœå•é¡¹ç‚¹å‡»äº‹ä»¶
	document.querySelectorAll(".menu-item").forEach((item) => {
		item.addEventListener("click", function (event) {
			event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
			const actionText = this.textContent.trim();
			promptInput.value = actionText;
			// if (currentRange) {
			// 	quill.setSelection(currentRange.index, currentRange.length);
			// }
			console.log("å‚ç›´èœå•ç‚¹å‡»äº†");
			sendBtn.click();
		});
	});

	// æ˜¾ç¤ºå¯¼å‡ºèœå•
	function showExportMenu() {
		const exportMenu = document.getElementById("exportMenu");
		const toolbarButton = document.querySelector(".ql-export");
		const rect = toolbarButton.getBoundingClientRect();

		exportMenu.style.display = "block";
		exportMenu.style.top = `${rect.bottom + window.scrollY}px`;
		exportMenu.style.left = `${rect.left}px`;
	}

	// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å¯¼å‡ºèœå•
	document.addEventListener("click", function (e) {
		const exportMenu = document.getElementById("exportMenu");
		const exportButton = document.querySelector(".ql-export");
		if (!exportMenu.contains(e.target) && !exportButton.contains(e.target)) {
			exportMenu.style.display = "none";
		}
	});

	// markdownå¯¼å‡ºåŠŸèƒ½
	function exportToMarkdown() {
		// åˆ›å»º TurndownService å®ä¾‹
		const turndownService = new TurndownService({
			headingStyle: "atx",
			codeBlock: "```",
			emDelimiter: "_",
		});

		// æ·»åŠ è¡¨æ ¼è½¬æ¢è§„åˆ™
		turndownService.addRule("table", {
			filter: "table",
			replacement: function (content, node) {
				// å¤„ç†è¡¨æ ¼å†…å®¹
				const rows = node.querySelectorAll("tr");
				let markdownTable = "";

				// å¤„ç†è¡¨å¤´
				const headerRow = rows[0];
				const headers = headerRow.querySelectorAll("th, td");
				markdownTable +=
					"| " +
					Array.from(headers)
						.map((header) => turndownService.turndown(header.innerHTML.trim()))
						.join(" | ") +
					" |\n";

				// å¤„ç†è¡¨å¤´åˆ†éš”çº¿
				markdownTable +=
					"| " +
					Array.from(headers)
						.map(() => "---")
						.join(" | ") +
					" |\n";

				// å¤„ç†è¡¨æ ¼æ•°æ®è¡Œ
				for (let i = 1; i < rows.length; i++) {
					const cells = rows[i].querySelectorAll("td");
					markdownTable +=
						"| " +
						Array.from(cells)
							.map((cell) => turndownService.turndown(cell.innerHTML.trim()))
							.join(" | ") +
						" |\n";
				}

				return markdownTable;
			},
		});

		// è·å–ç¼–è¾‘å™¨å†…å®¹
		const htmlContent = quill.root.innerHTML;

		// è½¬æ¢ä¸º Markdown
		const markdownContent = turndownService.turndown(htmlContent);
		console.log("ğŸš€ ~ exportToMarkdown ~ markdownContent:", markdownContent);

		// åˆ›å»º Blob
		const blob = new Blob([markdownContent], { type: "text/markdown" });

		// åˆ›å»ºä¸‹è½½é“¾æ¥
		const url = window.URL.createObjectURL(blob);
		const a = document.createElement("a");
		a.href = url;
		a.download = "document.md";

		// è§¦å‘ä¸‹è½½
		document.body.appendChild(a);
		a.click();

		// æ¸…ç†
		window.URL.revokeObjectURL(url);
		document.body.removeChild(a);
	}

	// æ·»åŠ å¯¼å‡ºåŠŸèƒ½
	document.querySelectorAll(".export-menu-item").forEach((item) => {
		item.addEventListener("click", function () {
			const format = this.dataset.format;
			switch (format) {
				case "markdown":
					exportToMarkdown();
					break;
				case "docx":
					exportToWord();
					break;
				case "pdf":
					exportToPDF();
					break;
			}
			document.getElementById("exportMenu").style.display = "none";
		});
	});

	// æ›´æ–° Word å¯¼å‡ºåŠŸèƒ½
	function htmlTableToDocxTable(htmlTable) {
		const rows = [];
		htmlTable.querySelectorAll("tr").forEach((tr) => {
			const cells = [];
			tr.querySelectorAll("th, td").forEach((td) => {
				const paragraph = new docx.Paragraph({
					children: [new docx.TextRun(td.textContent)],
				});
				cells.push(new docx.TableCell({ children: [paragraph] }));
			});

			// è®¾ç½®è¡Œé«˜
			rows.push(
				new docx.TableRow({
					children: cells,
					height: {
						value: 800, // è¡Œé«˜å€¼ï¼ˆå•ä½ä¸º dxaï¼Œ1/20 ç£…ï¼‰
						rule: docx.HeightRule.ATLEAST, // è¡Œé«˜è§„åˆ™
					},
				})
			);
		});

		// è®¾ç½®è¡¨æ ¼å®½åº¦å’Œåˆ—å®½
		return new docx.Table({
			rows,
			width: {
				size: 100, // è¡¨æ ¼å®½åº¦ä¸º 100%
				type: docx.WidthType.PERCENTAGE,
			},
			columnWidths: [3000, 3000], // æ¯åˆ—å®½åº¦ï¼ˆå•ä½ä¸º dxaï¼‰
		});
	}

	// å°† HTML å†…å®¹è½¬æ¢ä¸º docx æ®µè½
	function htmlToDocxParagraphs(element) {
		const paragraphs = [];
		element.childNodes.forEach((node) => {
			if (node.nodeType === Node.TEXT_NODE) {
				// å¤„ç†æ–‡æœ¬èŠ‚ç‚¹
				if (node.textContent.trim()) {
					paragraphs.push(
						new docx.Paragraph({
							children: [new docx.TextRun(node.textContent)],
						})
					);
				}
			} else if (node.nodeType === Node.ELEMENT_NODE) {
				// å¤„ç†å…ƒç´ èŠ‚ç‚¹
				if (node.tagName === "P") {
					// æ®µè½
					paragraphs.push(
						new docx.Paragraph({
							children: [new docx.TextRun(node.textContent)],
						})
					);
				} else if (node.tagName === "TABLE") {
					// è¡¨æ ¼
					paragraphs.push(htmlTableToDocxTable(node));
				} else if (node.tagName === "STRONG" || node.tagName === "B") {
					// åŠ ç²—æ–‡æœ¬
					paragraphs.push(
						new docx.Paragraph({
							children: [
								new docx.TextRun({ text: node.textContent, bold: true }),
							],
						})
					);
				} else if (node.tagName === "EM" || node.tagName === "I") {
					// æ–œä½“æ–‡æœ¬
					paragraphs.push(
						new docx.Paragraph({
							children: [
								new docx.TextRun({ text: node.textContent, italics: true }),
							],
						})
					);
				} else {
					// å…¶ä»–å…ƒç´ ï¼ˆå¦‚ divã€span ç­‰ï¼‰
					paragraphs.push(
						new docx.Paragraph({
							children: [new docx.TextRun(node.textContent)],
						})
					);
				}
			}
		});
		return paragraphs;
	}

	// å¯¼å‡ºä¸º Word æ–‡æ¡£
	async function exportToWord() {
		try {
			const element = quill.root; // è·å– Quill çš„æ ¹ DOM å…ƒç´ 

			// å°† HTML å†…å®¹è½¬æ¢ä¸º docx æ®µè½
			const paragraphs = htmlToDocxParagraphs(element);

			// åˆ›å»º Word æ–‡æ¡£
			const docDocument = new docx.Document({
				sections: [
					{
						properties: {},
						children: paragraphs, // æ·»åŠ æ®µè½å’Œè¡¨æ ¼
					},
				],
			});

			// ç”Ÿæˆå¹¶ä¸‹è½½ Word æ–‡ä»¶
			const blob = await docx.Packer.toBlob(docDocument);
			const url = window.URL.createObjectURL(blob);
			const a = document.createElement("a");
			a.href = url;
			a.download = "export.docx";
			a.click();
			window.URL.revokeObjectURL(url);
		} catch (error) {
			console.error("Export to Word failed:", error);
		}
	}

	// PDFå¯¼å‡ºåŠŸèƒ½
	function exportToPDF() {
		const element = quill.root;
		const opt = {
			margin: 1,
			filename: "document.pdf",
			html2canvas: { scale: 2 },
			jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
		};

		html2pdf().set(opt).from(element).save();
	}

	// ä¿®æ”¹ Markdown æ¸²æŸ“åŠŸèƒ½
	function renderMarkdown(markdownText) {
		try {
			const md = window
				.markdownit({
					html: true,
					breaks: true,
					linkify: true,
				})
				.use(function (md) {
					// è‡ªå®šä¹‰è¡¨æ ¼å’Œä»£ç å—æ¸²æŸ“
					// å®Œå…¨è¦†ç›–è¡¨æ ¼æ¸²æŸ“è§„åˆ™
					md.renderer.rules.table_open = () => "<table><tbody>";
					md.renderer.rules.table_close = () => "</tbody></table>";
					md.renderer.rules.tr_open = () => "<tr>";
					md.renderer.rules.th_open = () => '<td data-header="true">'; // ç”¨ td ä½†æ ‡è®°ä¸º header

					// ä¿®æ”¹ä»£ç å—æ¸²æŸ“è§„åˆ™ï¼ˆcode_block å’Œ fenceï¼‰
					md.renderer.rules.code_block = function (tokens, idx) {
						//ä»£ç å—çš„æ ¼å¼æ”¯æŒ
						/* return (
							// "<pre><code>" +
							md.utils.escapeHtml(tokens[idx].content) + "\n"
							// "</code></pre>\n"
						); */
						return md.utils.escapeHtml(tokens[idx].content) + "\n";
					};

					md.renderer.rules.fence = function (tokens, idx) {
						return md.utils.escapeHtml(tokens[idx].content) + "\n";
					};
				});

			const html = md
				.render(markdownText)
				.replace(/<th>/g, '<td data-header="true">') // æ›¿æ¢ th ä¸ºæ ‡è®°çš„ td
				.replace(/<\/th>/g, "</td>");
			console.log("ğŸš€ ~ renderMarkdown ~ html:", html);
			// è·å–å½“å‰å…‰æ ‡ä½ç½®
			const currentSelection = quill.getSelection();
			let cursorPosition = currentSelection
				? currentSelection.index
				: quill.getLength();

			// åœ¨å…‰æ ‡ä½ç½®æ’å…¥ HTML
			quill.clipboard.dangerouslyPasteHTML(cursorPosition, html);

			// è®¡ç®—æ–°å…‰æ ‡ä½ç½®ï¼ˆæ’å…¥å†…å®¹çš„é•¿åº¦ï¼‰
			const delta = quill.clipboard.convert(html);
			const insertedLength = delta.reduce(
				(acc, op) => acc + (op.insert ? op.insert.length || 1 : 0),
				0
			);

			// ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥å†…å®¹æœ«å°¾
			quill.setSelection(cursorPosition + insertedLength, 0);
		} catch (error) {
			console.error("Markdown rendering failed:", error);
		}
	}

	// æµ‹è¯•ç”¨çš„ Markdown æ–‡æœ¬
	const testMarkdown = `# è¿™æ˜¯ä¸€ä¸ªæ ‡é¢˜

			è¿™æ˜¯ä¸€æ®µæ™®é€šæ–‡æœ¬ï¼ŒåŒ…å«**ç²—ä½“**å’Œ*æ–œä½“*ã€‚

			## åˆ—è¡¨ç¤ºä¾‹
			- é¡¹ç›® 1
			- é¡¹ç›® 2
			- å­é¡¹ç›® A
			- å­é¡¹ç›® B

			## ä»£ç ç¤ºä¾‹
			\`\`\`javascript
			function hello() {
				console.log("Hello, World!");
			}
			\`\`\`

			## è¡¨æ ¼ç¤ºä¾‹
			| åˆ—1 | åˆ—2 | åˆ—3 |
			|-----|-----|-----|
			| A1  | B1  | C1  |
			| A2  | B2  | C2  |
			`;

	// æµ‹è¯•æ¸²æŸ“å‡½æ•°
	function testMarkdownRender() {
		renderMarkdown(testMarkdown);
	}

	// ä¿®æ”¹ Monaco Editor çš„åˆå§‹åŒ–é…ç½®
	require.config({
		paths: {
			vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs",
		},
	});

	// åˆå§‹åŒ–æ—¶é¢„åŠ è½½ Monaco Editor
	require(["vs/editor/editor.main"], function () {
		monacoLoaded = true;
		console.log("Monaco Editor loaded successfully");
	});

	// æ·»åŠ å…¨å±€å˜é‡
	let diffEditor = null;
	let monacoLoaded = false;

	// ä¿®å¤æ›¿æ¢æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†
	document.getElementById("replace").addEventListener("click", () => {
		if (!monacoLoaded) {
			console.log("Monaco Editor is still loading...");
			return;
		}

		const selectedText = currentRange
			? quill.getText(currentRange.index, currentRange.length)
			: "";

		// ä» AI å“åº”å†…å®¹ä¸­æå–å®é™…çš„å›ç­”éƒ¨åˆ†
		const aiResponseText =
			aiResponse.querySelector(".response-content").textContent;
		const actualResponse = aiResponseText.split("AIçš„å›ç­”ï¼š")[1]; // è·å– AI å›ç­”éƒ¨åˆ†

		// ç¡®ä¿æœ‰é€‰ä¸­çš„æ–‡æœ¬å’Œ AI çš„å›ç­”
		if (!selectedText || !actualResponse) {
			console.log("No selected text or AI response");
			return;
		}

		showDiffEditor(selectedText, actualResponse);
	});

	// å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
	document.getElementById("cancelReplace").addEventListener("click", () => {
		// 1. å…³é—­å¯¹æ¯”ç¼–è¾‘å™¨æµ®å±‚
		closeDiffEditor();

		// 2. æ¸…é™¤æ–‡æœ¬é«˜äº®
		clearHighlight();

		// 3. éšè—æµ®åŠ¨è¾“å…¥æ¡†å’ŒAIå“åº”
		floatingInput.style.display = "none";
		aiResponse.style.display = "none";
		actionButtons.style.display = "none";

		// 4. é‡ç½®è¾“å…¥æ¡†å†…å®¹
		promptInput.value = "";

		// 5. é‡ç½®å…¶ä»–çŠ¶æ€
		currentRange = null;
		posCloseToBottom = false;
	});

	// æ·»åŠ å¤åˆ¶ AI å“åº”å†…å®¹çš„å‡½æ•°
	function copyAiResponse() {
		const responseContent =
			aiResponse.querySelector(".response-content").textContent;

		if (responseContent) {
			navigator.clipboard.writeText(responseContent).then(() => {
				const copyBtn = document.getElementById("aiResponseCopyBtn");
				const originalText = copyBtn.innerHTML;

				// æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
				copyBtn.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';

				// 2ç§’åæ¢å¤åŸå§‹æ–‡æœ¬
				setTimeout(() => {
					copyBtn.innerHTML = originalText;
				}, 2000);
			});
		}
	}

	// æ·»åŠ å¤åˆ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	document
		.getElementById("aiResponseCopyBtn")
		.addEventListener("click", copyAiResponse);

	// æ·»åŠ é‡æ–°ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
	document
		.getElementById("aiResponseRegenerateBtn")
		.addEventListener("click", function () {
			// è·å–å½“å‰çš„ prompt
			const prompt = promptInput.value;
			if (!prompt) return;

			// æ˜¾ç¤ºç”Ÿæˆä¸­çŠ¶æ€
			const responseContent = aiResponse.querySelector(".response-content");
			const copyBtn = document.getElementById("aiResponseCopyBtn");
			const regenerateBtn = document.getElementById("aiResponseRegenerateBtn");

			copyBtn.style.display = "none";
			regenerateBtn.style.display = "none";
			responseContent.textContent = "æ­£åœ¨é‡æ–°ç”Ÿæˆ...";

			// æ¨¡æ‹ŸAPIè°ƒç”¨
			setTimeout(() => {
				responseContent.textContent = `é‡æ–°ç”Ÿæˆçš„å†…å®¹ï¼š${prompt} (${new Date().toLocaleTimeString()})`;
				copyBtn.style.display = "flex";
				regenerateBtn.style.display = "flex";
			}, 1000);
		});

	// æ·»åŠ åˆ°é‡ç½®çŠ¶æ€çš„å‡½æ•°ä¸­
	function resetEditorState() {
		clearHighlight();
		currentRange = null;
		floatingInput.style.display = "none";
		aiResponse.style.display = "none";
		actionButtons.style.display = "none";
		document.getElementById("aiResponseCopyBtn").style.display = "none"; // éšè—å¤åˆ¶æŒ‰é’®
		document.getElementById("aiResponseRegenerateBtn").style.display = "none"; // éšè—é‡æ–°ç”ŸæˆæŒ‰é’®
		promptInput.value = "";
		posCloseToBottom = false;
	}
</script>
