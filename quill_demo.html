<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<link
	href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css"
	rel="stylesheet"
/>
<!-- <script
	src="https://cdnjs.cloudflare.com/ajax/libs/quill/2.0.0-dev.3/quill.min.js"
	type="text/javascript"
></script> -->
<script
	src="https://unpkg.com/quill-table-ui@1.0.5/dist/umd/index.js"
	type="text/javascript"
></script>
<!-- <link
	href="https://cdnjs.cloudflare.com/ajax/libs/quill/2.0.0-dev.3/quill.snow.min.css"
	rel="stylesheet"
/> -->
<link
	href="https://unpkg.com/quill-table-ui@1.0.5/dist/index.css"
	rel="stylesheet"
/>
<style>
	/* ç¡®ä¿å·¥å…·æ æ˜¯ flex å¸ƒå±€ï¼Œå¹¶ä¸”æ–°æŒ‰é’®ä¼šè¢«æ”¾ç½®åœ¨æœ«å°¾ */
	.ql-toolbar {
		display: flex;
		justify-content: flex-start; /* ç¡®ä¿æŒ‰é’®æŒ‰ç…§é¡ºåºæ’åˆ— */
		flex-wrap: wrap;
	}

	.editor-container {
		max-width: 800px;
		margin: 0 auto;
		padding: 20px;
	}

	.ql-container .ql-editor::selection,
	.ql-container .ql-editor *::selection {
		background-color: #b4d5fe;
	}

	.floating-input {
		position: fixed; /* æ”¹ä¸º fixed å®šä½ */
		display: none;
		background: white;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		border-radius: 8px;
		padding: 10px;
		width: 300px;
		z-index: 9999;
	}

	.input-container {
		display: flex;
		gap: 8px;
		margin-bottom: 10px;
	}

	.input-container input {
		flex: 1;
		padding: 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
	}

	.send-btn {
		background: #409eff;
		border: none;
		border-radius: 4px;
		padding: 8px;
		color: white;
		cursor: pointer;
	}

	.ai-response {
		background: #f5f5f5;
		padding: 10px;
		border-radius: 4px;
		margin-top: 10px;
		display: none;
	}

	.action-buttons {
		display: none;
		gap: 8px;
		margin-top: 8px;
	}

	.action-buttons button {
		padding: 4px 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
		cursor: pointer;
	}

	.highlight-selection {
		background-color: #b4d5fe !important;
	}

	/* æ·»åŠ å‚ç›´èœå•æ ·å¼ */
	.vertical-menu {
		position: fixed;
		display: none;
		background: white;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		border-radius: 8px;
		width: 300px;
		z-index: 9998;
	}

	.menu-item {
		padding: 10px 15px;
		cursor: pointer;
		transition: background-color 0.2s;
	}

	.menu-item:hover {
		background-color: #f5f5f5;
	}

	.menu-item + .menu-item {
		border-top: 1px solid #eee;
	}

	.ql-customButton::before {
		font-family: "Font Awesome 5 Free";
		content: "\f1c5"; /* è¡¨æ ¼å›¾æ ‡çš„ Unicode */
		margin-right: 8px;
	}
</style>

<div class="editor-container">
	<div id="editor">
		<h2>Demo Content</h2>
		<p>Preset build with <code>snow</code> theme, and some common formats.</p>
	</div>
</div>

<div class="floating-input" id="floatingInput">
	<div class="input-container">
		<input type="text" id="promptInput" placeholder="è¾“å…¥æç¤º..." />
		<button class="send-btn" id="sendBtn">âœˆï¸</button>
	</div>
	<div class="ai-response" id="aiResponse"></div>
	<div class="action-buttons" id="actionButtons">
		<button id="insertAfter">æ’å…¥åˆ°åé¢</button>
		<button id="replace">æ›¿æ¢é€‰ä¸­å†…å®¹</button>
	</div>
</div>

<!-- å‚ç›´èœå•HTMLç»“æ„ -->
<div class="vertical-menu" id="verticalMenu">
	<div class="menu-item">âœï¸ æ”¹å†™è¿™æ®µå†…å®¹</div>
	<div class="menu-item">ğŸ”„ ç”Ÿæˆç›¸ä¼¼å†…å®¹</div>
	<div class="menu-item">ğŸ“ æ€»ç»“è¿™æ®µå†…å®¹</div>
	<div class="menu-item">ğŸ¯ ä¼˜åŒ–è¿™æ®µå†…å®¹</div>
</div>

<script>
	Quill.register("modules/tableUI", quillTableUI.default);

	const options = {
		// debug: "info",
		modules: {
			table: true,
			tableUI: true,
			toolbar: {
				container: [
					[{ header: [1, 2, false] }],
					["bold", "italic", "underline"],
					["image", "code-block"],
				],
			},
		},

		placeholder: "Compose an epic...",
		theme: "snow",
	};
	const quill = new Quill("#editor", options);
	const table = quill.getModule("table");
	// åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æŒ‰é’®
	const CustomButton = function () {
		const button = document.createElement("button");
		// åˆ›å»ºä¸€ä¸ª SVG å›¾æ ‡
		const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
		svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
		svg.setAttribute("viewBox", "0 0 1024 1024"); // ä½¿ç”¨ä½ çš„ SVG çš„ viewBox
		svg.setAttribute("width", "20"); // è®¾ç½®å›¾æ ‡å®½åº¦
		svg.setAttribute("height", "20"); // è®¾ç½®å›¾æ ‡é«˜åº¦
		svg.setAttribute("t", "1737353285482"); // ä½ çš„ SVG ä¸­çš„è‡ªå®šä¹‰å±æ€§
		svg.setAttribute("p-id", "4300"); // ä½ çš„ SVG ä¸­çš„è‡ªå®šä¹‰å±æ€§

		// åˆ›å»ºè¡¨æ ¼å›¾æ ‡çš„è·¯å¾„
		const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
		path.setAttribute(
			"d",
			"M959.825022 384.002258V191.939717C959.825022 121.2479 902.517291 63.940169 831.825474 63.940169H191.939717C121.2479 63.940169 63.940169 121.2479 63.940169 191.939717v639.885757C63.940169 902.517291 121.2479 959.825022 191.939717 959.825022h639.885757c70.691817 0 127.999548-57.307731 127.999548-127.999548V384.002258zM146.66502 146.66502a63.737872 63.737872 0 0 1 45.336109-18.784682h639.997742A63.961844 63.961844 0 0 1 895.884854 192.001129V320.062089H127.880338V192.001129A63.737872 63.737872 0 0 1 146.66502 146.66502z m269.1267 461.308451v-223.971213h192.181751v223.971213h-192.181751z m192.181751 63.940169v223.971214h-192.181751v-223.971214h192.181751z m-256.12192-63.940169H127.880338v-223.971213h223.971213v223.971213z m-205.186531 269.235073a63.466939 63.466939 0 0 1-18.784682-45.209673V671.91364h223.971213v223.971214H192.001129a63.625887 63.625887 0 0 1-45.336109-18.67631z m749.219834-45.209673A63.763159 63.763159 0 0 1 831.998871 895.884854H671.91364v-223.971214h223.971214v160.085231z m0-224.0254h-223.971214v-223.971213h223.971214v223.971213z"
		);
		path.setAttribute("fill", "#000"); // è®¾ç½®å›¾æ ‡é¢œè‰²
		path.setAttribute("p-id", "4301"); // ä½ çš„ SVG ä¸­çš„è‡ªå®šä¹‰å±æ€§

		// å°†è·¯å¾„æ·»åŠ åˆ° SVG ä¸­
		svg.appendChild(path);

		// å°† SVG å›¾æ ‡æ·»åŠ åˆ°æŒ‰é’®
		button.appendChild(svg);
		button.onclick = function () {
			// åœ¨æŒ‰é’®ç‚¹å‡»æ—¶è§¦å‘çš„åŠŸèƒ½
			console.log("Insert Table clicked!");
			table.insertTable(3, 3);
		};
		return button;
	};
	const toolbar = quill.getModule("toolbar");
	const toolbarContainer = toolbar.container;

	const customButton = new CustomButton();
	toolbarContainer.appendChild(customButton);

	let currentRange = null;

	const floatingInput = document.getElementById("floatingInput");
	const promptInput = document.getElementById("promptInput");
	const sendBtn = document.getElementById("sendBtn");
	const aiResponse = document.getElementById("aiResponse");
	const actionButtons = document.getElementById("actionButtons");

	// document
	// 	.querySelector(".ql-customButton")
	// 	.addEventListener("click", function () {
	// 		table.insertTable(3, 3);
	// 	});

	// é€‰ä¸­å†…å®¹éƒ¨åˆ†çš„é«˜äº®å¤„ç†
	function highlightSelection(range) {
		if (range && range.length > 0) {
			quill.formatText(range.index, range.length, "background", "#b4d5fe");
		}
	}

	function clearHighlight() {
		if (currentRange) {
			quill.formatText(
				currentRange.index,
				currentRange.length,
				"background",
				false
			);
		}
	}

	/**
	 * å¤„ç† Quill ç¼–è¾‘å™¨ä¸­çš„é€‰æ‹©å˜åŒ–äº‹ä»¶
	 *
	 * @param {Object} range - å½“å‰é€‰æ‹©çš„èŒƒå›´å¯¹è±¡ï¼Œ{index, length}ã€‚
	 * @param {Object} oldRange - ä¹‹å‰çš„é€‰æ‹©èŒƒå›´å¯¹è±¡ã€‚
	 * @param {string} source - è§¦å‘é€‰æ‹©å˜åŒ–çš„æ¥æºï¼Œä¾‹å¦‚ 'user' æˆ– 'api'ã€‚
	 * é€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œåœ¨é€‰ä¸­æ–‡æœ¬æ—¶quillå†…éƒ¨emitå¯¹åº”çš„æ—¶é—´åçš„å›è°ƒ
	 */
	quill.on("selection-change", function (range, oldRange, source) {
		console.log("ğŸš€ ~ range:", range);
		if (range && range.length > 0) {
			//é€‰ä¸­å†…å®¹åï¼Œç»§ç»­é€‰ä¸­æ–°çš„å†…å®¹æ—¶ï¼Œæ¸…é™¤ä¹‹å‰é€‰ä¸­å†…å®¹çš„é«˜äº®
			if (currentRange) clearHighlight();

			//getBounds() æ–¹æ³•ç”¨äºè·å–æ–‡æœ¬é€‰åŒºçš„ä½ç½®å’Œå°ºå¯¸ä¿¡æ¯,ç›¸å¯¹äºå·¦ä¸Šè§’åŸç‚¹
			const bounds = quill.getBounds(range.index, range.length);
			currentRange = range;

			// æ·»åŠ é«˜äº®
			highlightSelection(range);

			// è·å–ç¼–è¾‘å™¨å®¹å™¨çš„ä½ç½®ä¿¡æ¯
			const editorRect = quill.container.getBoundingClientRect();

			// è®¡ç®—è¾“å…¥æ¡†çš„ä½ç½®
			//é¡¶éƒ¨ä½ç½® = ç¼–è¾‘å™¨å®¹å™¨çš„é¡¶éƒ¨è·ç¦»è§†å£é¡¶éƒ¨ + é€‰ä¸­æ–‡æœ¬çš„åº•éƒ¨è·ç¦»ç¼–è¾‘å®¹å™¨é¡¶éƒ¨ + 10px
			const topPosition = editorRect.top + bounds.bottom + 10; // åœ¨é€‰ä¸­æ–‡æœ¬ä¸‹æ–¹10px
			const leftPosition = editorRect.left + bounds.left;

			floatingInput.style.display = "block";
			floatingInput.style.top = `${topPosition}px`;
			floatingInput.style.left = `${leftPosition}px`;

			// è®¾ç½®å‚ç›´èœå•çš„ä½ç½®ï¼Œåœ¨å¯¹è¯æ¡†ä¸‹æ–¹
			const verticalMenu = document.getElementById("verticalMenu");
			verticalMenu.style.display = "block";
			verticalMenu.style.top = `${
				topPosition + floatingInput.offsetHeight + 10
			}px`;
			verticalMenu.style.left = `${leftPosition}px`;
		} else if (!range) {
			console.log("ğŸš€ ~ !range:", !range);
			// ç‚¹å‡»ç¼–è¾‘å™¨å¤–éƒ¨æ—¶éšè—è¾“å…¥æ¡†ï¼Œä½†ç‚¹å‡»è¾“å…¥æ¡†æœ¬èº«æ—¶ä¸éšè—
			if (!floatingInput.contains(document.activeElement)) {
				clearHighlight();
				floatingInput.style.display = "none";
				const verticalMenu = document.getElementById("verticalMenu");
				verticalMenu.style.display = "none"; // éšè—èœå•
			}
		}
	});

	// å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	sendBtn.addEventListener("click", async () => {
		const prompt = promptInput.value;
		if (!prompt) return;

		// è·å–é€‰ä¸­çš„æ–‡æœ¬
		const selectedText = currentRange
			? quill.getText(currentRange.index, currentRange.length)
			: "";

		// æ¨¡æ‹ŸAIå“åº”
		aiResponse.style.display = "block";
		aiResponse.textContent = "æ­£åœ¨ç”Ÿæˆå›ç­”...";

		// æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
		setTimeout(() => {
			aiResponse.textContent = `é€‰ä¸­çš„æ–‡æœ¬æ˜¯ï¼š${selectedText}  AIçš„å›ç­”ï¼š${prompt}`;
			actionButtons.style.display = "flex";
		}, 1000);
	});

	// æ·»åŠ æ¸è¿›å¼æ’å…¥æ–‡æœ¬çš„å‡½æ•°
	async function progressiveInsert(text, startIndex, isReplace = false) {
		const delay = 50; // æ¯ä¸ªå­—ç¬¦æ’å…¥çš„å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

		if (isReplace) {
			clearHighlight();
			quill.deleteText(currentRange.index, currentRange.length);
		}

		const insertPosition = isReplace ? currentRange.index : startIndex;
		let currentPosition = insertPosition;

		for (let i = 0; i < text.length; i++) {
			await new Promise((resolve) => setTimeout(resolve, delay));
			quill.insertText(currentPosition, text[i]);
			currentPosition++;
		}
		return Promise.resolve();
	}

	// æ’å…¥å†…å®¹çš„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	document.getElementById("insertAfter").addEventListener("click", () => {
		if (currentRange && aiResponse.textContent) {
			const insertIndex = currentRange.index + currentRange.length;
			progressiveInsert(" " + aiResponse.textContent, insertIndex).then(() => {
				clearHighlight();
			});
		}
	});

	// æ›¿æ¢å†…å®¹çš„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	document.getElementById("replace").addEventListener("click", () => {
		if (currentRange && aiResponse.textContent) {
			progressiveInsert(aiResponse.textContent, currentRange.index, true).then(
				() => {
					clearHighlight();
				}
			);
		}
	});

	// ç§»é™¤åŸæœ‰çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œæ”¹ç”¨æ–°çš„é€»è¾‘
	document.addEventListener("mouseup", (event) => {
		// å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿selection-changeäº‹ä»¶å…ˆè§¦å‘
		setTimeout(() => {
			const target = event.target;
			const verticalMenu = document.getElementById("verticalMenu");
			const isInVerticalMenu = verticalMenu.contains(target);
			// æ£€æŸ¥ç‚¹å‡»ç›®æ ‡æ˜¯å¦åœ¨å…è®¸çš„åŒºåŸŸå†…
			const isInFloatingInput = floatingInput.contains(target);
			const isInEditor = quill.container.contains(target);
			const hasSelection =
				quill.getSelection() && quill.getSelection().length > 0;
			const isToolbar = toolbarContainer.contains(target);

			/* 			console.log(
				"toolbarContainers > target",
				toolbarContainer.contains(target)
			); */

			// å¦‚æœç‚¹å‡»åœ¨å…è®¸åŒºåŸŸå¤–ï¼Œä¸”ä¸æ˜¯åœ¨é€‰æ‹©æ–‡æœ¬
			if (!isInFloatingInput && !hasSelection && !isInVerticalMenu) {
				floatingInput.style.display = "none";
				aiResponse.style.display = "none";
				actionButtons.style.display = "none";
				verticalMenu.style.display = "none"; // éšè—èœå•
				promptInput.value = "";
				clearHighlight(); // æ¸…é™¤é«˜äº®
			}
		}, 0);
	});

	// æ·»åŠ èœå•é¡¹ç‚¹å‡»äº‹ä»¶
	document.querySelectorAll(".menu-item").forEach((item) => {
		item.addEventListener("click", function () {
			const actionText = this.textContent.trim();
			promptInput.value = actionText;
			sendBtn.click();
			verticalMenu.style.display = "none"; // éšè—èœå•
		});
	});
</script>
