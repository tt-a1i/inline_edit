<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<link
	href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css"
	rel="stylesheet"
/>
<script
	src="https://unpkg.com/quill-table-ui@1.0.5/dist/umd/index.js"
	type="text/javascript"
></script>
<link
	href="https://unpkg.com/quill-table-ui@1.0.5/dist/index.css"
	rel="stylesheet"
/>
<!-- åœ¨å…¶ä»– script æ ‡ç­¾åæ·»åŠ  Turndown -->
<script src="https://unpkg.com/turndown/dist/turndown.js"></script>
<script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- æ·»åŠ  Font Awesome å›¾æ ‡åº“ -->
<link
	rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>
<!-- åœ¨å…¶ä»– script æ ‡ç­¾åæ·»åŠ  markdown-it -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
<style>
	/* flex å¸ƒå±€ï¼Œæ–°æŒ‰é’®ä¼šè¢«æ”¾ç½®åœ¨æœ«å°¾ */
	.ql-toolbar {
		display: flex;
		justify-content: flex-start; /* ç¡®ä¿æŒ‰é’®æŒ‰ç…§é¡ºåºæ’åˆ— */
		flex-wrap: wrap;
	}

	.editor-container {
		max-width: 800px;
		margin: 0 auto;
		padding: 20px;
		background-color: #f9fafd;
		min-height: 100vh;
	}

	.ql-container .ql-editor::selection,
	.ql-container .ql-editor *::selection {
		background-color: #b4d5fe;
	}

	.floating-input {
		position: fixed;
		display: none;
		background: white;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		border-radius: 8px;
		padding: 10px;
		width: 300px;
		z-index: 9999;
	}

	.input-container {
		display: flex;
		gap: 8px;
		margin-bottom: 10px;
	}

	.input-container input {
		flex: 1;
		padding: 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
	}

	.send-btn {
		background: #409eff;
		border: none;
		border-radius: 8px;
		padding: 8px 16px;
		color: white;
		cursor: pointer;
		display: flex;
		align-items: center;
		gap: 6px;
		transition: all 0.3s ease;
		font-size: 14px;
	}

	.send-btn:hover {
		background: #66b1ff;
		transform: translateY(-1px);
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}

	.send-btn:active {
		transform: translateY(0);
		box-shadow: none;
	}

	.send-btn i {
		font-size: 14px;
	}

	.ai-response {
		background: #f5f5f5;
		padding: 10px;
		border-radius: 4px;
		margin-top: 10px;
		display: none;
	}

	.action-buttons {
		display: none;
		gap: 8px;
		margin-top: 8px;
	}

	.action-buttons button {
		padding: 4px 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
		cursor: pointer;
	}

	.highlight-selection {
		background-color: #b4d5fe !important;
	}

	/* æ·»åŠ å‚ç›´èœå•æ ·å¼ */
	.vertical-menu {
		position: fixed;
		display: none;
		background: white;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		border-radius: 8px;
		width: 300px;
		z-index: 9998;
	}

	.menu-item {
		padding: 10px 15px;
		cursor: pointer;
		transition: background-color 0.2s;
	}

	.menu-item:hover {
		background-color: #f5f5f5;
	}

	.menu-item + .menu-item {
		border-top: 1px solid #eee;
	}

	.ql-customButton::before {
		font-family: "Font Awesome 5 Free";
		content: "\f1c5"; /* è¡¨æ ¼å›¾æ ‡çš„ Unicode */
		margin-right: 8px;
	}

	.ql-exportMd::before {
		font-family: "Font Awesome 5 Free";
		content: "\f56d"; /* Markdown icon */
		margin-right: 8px;
	}

	.export-menu {
		position: absolute;
		display: none;
		background: white;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		border-radius: 4px;
		z-index: 1000;
	}

	.export-menu-item {
		padding: 8px 16px;
		cursor: pointer;
		white-space: nowrap;
	}

	.export-menu-item:hover {
		background-color: #f5f5f5;
	}

	.export-menu-item + .export-menu-item {
		border-top: 1px solid #eee;
	}

	/* æ·»åŠ å¯¼å‡ºæŒ‰é’®æ ·å¼ */
	.ql-export {
		position: relative;
		width: 28px;
		height: 24px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.ql-export::before {
		font-family: "Font Awesome 5 Free";
		content: "\f56e"; /* å¯¼å‡ºå›¾æ ‡çš„ Unicode */
		font-weight: 900;
		font-size: 14px;
	}

	/* å¯é€‰ï¼šæ·»åŠ æ‚¬åœæ•ˆæœ */
	.ql-export:hover {
		color: #06c;
	}

	/* ä¿®æ”¹è¡¨æ ¼æŒ‰é’®æ ·å¼ */
	.ql-table {
		position: relative;
		width: 28px;
		height: 24px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.ql-table:hover {
		color: #06c;
	}

	/* æµ‹è¯•æŒ‰é’®æ ·å¼ */
	.test-markdown-btn {
		position: fixed;
		bottom: 20px;
		right: 20px;
		padding: 10px 20px;
		background: #409eff;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		z-index: 1000;
	}

	.test-markdown-btn:hover {
		background: #66b1ff;
	}

	/* æ·»åŠ ç¼–è¾‘å™¨èƒŒæ™¯è‰² */
	.ql-container.ql-snow {
		background-color: #ffffff;
		border-radius: 0 0 4px 4px;
	}

	.ql-toolbar.ql-snow {
		border-radius: 4px 4px 0 0;
		background-color: #ffffff;
	}

	/* æ·»åŠ bodyèƒŒæ™¯è‰² */
	body {
		margin: 0;
		padding: 0;
		background-color: #f9fafd;
	}

	/* æ·»åŠ æ’¤é”€é‡åšæŒ‰é’®æ ·å¼ */
	.ql-undo,
	.ql-redo {
		position: relative;
		width: 28px;
		height: 24px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.ql-undo::before {
		font-family: "Font Awesome 5 Free";
		content: "\f0e2"; /* undo å›¾æ ‡ */
		font-weight: 900;
		font-size: 14px;
	}

	.ql-redo::before {
		font-family: "Font Awesome 5 Free";
		content: "\f01e"; /* redo å›¾æ ‡ */
		font-weight: 900;
		font-size: 14px;
	}

	.ql-undo:hover,
	.ql-redo:hover {
		color: #06c;
	}
	.ql-editor td[data-header="true"] {
		font-weight: bold;
		background: #f3f4f6;
	}
</style>

<div class="editor-container">
	<div id="editor">
		<h2>Demo Content</h2>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
		<p>Preset build with snow theme, and some common formats.</p>
	</div>
</div>

<div class="floating-input" id="floatingInput">
	<div class="input-container">
		<input type="text" id="promptInput" placeholder="è¾“å…¥æç¤º..." />
		<button class="send-btn" id="sendBtn">
			<i class="fas fa-paper-plane"></i>
			<span>å‘é€</span>
		</button>
	</div>
	<div class="ai-response" id="aiResponse"></div>
	<div class="action-buttons" id="actionButtons">
		<button id="insertAfter">æ’å…¥åˆ°åé¢</button>
		<button id="replace">æ›¿æ¢é€‰ä¸­å†…å®¹</button>
	</div>
</div>

<!-- å‚ç›´èœå•HTMLç»“æ„ -->
<div class="vertical-menu" id="verticalMenu">
	<div class="menu-item">âœï¸ æ”¹å†™è¿™æ®µå†…å®¹</div>
	<div class="menu-item">ğŸ”„ ç”Ÿæˆç›¸ä¼¼å†…å®¹</div>
	<div class="menu-item">ğŸ“ æ€»ç»“è¿™æ®µå†…å®¹</div>
	<div class="menu-item">ğŸ¯ ä¼˜åŒ–è¿™æ®µå†…å®¹</div>
</div>

<!-- åœ¨ editor-container div åæ·»åŠ å¯¼å‡ºèœå• -->
<div class="export-menu" id="exportMenu">
	<div class="export-menu-item" data-format="markdown">å¯¼å‡ºä¸º Markdown</div>
	<div class="export-menu-item" data-format="docx">å¯¼å‡ºä¸º Word</div>
	<div class="export-menu-item" data-format="pdf">å¯¼å‡ºä¸º PDF</div>
</div>

<!-- åœ¨ body æœ€åæ·»åŠ æµ‹è¯•æŒ‰é’® -->
<button class="test-markdown-btn" onclick="testMarkdownRender()">
	æµ‹è¯• Markdown æ¸²æŸ“
</button>

<script>
	//TODO diff
	//TODO é—®ç­”å¯¹è¯æ¡†çš„é€»è¾‘å®Œå–„
	//TODO åœ¨åº•éƒ¨è¿›è¡Œé€‰ä¸­å†…å®¹æ—¶çš„èœå•æ åœ¨ä¸å¯è§èŒƒå›´å†…çš„å¤„ç†
	Quill.register("modules/tableUI", quillTableUI.default);

	const options = {
		// debug: "info",
		modules: {
			table: true,
			tableUI: true,
			toolbar: {
				container: [
					["undo", "redo"], // æ·»åŠ æ’¤é”€é‡åšæŒ‰é’®
					[{ header: [1, 2, 3, false] }],
					["bold", "italic", "underline"],
					// ["code-block"],
					[{ list: "ordered" }, { list: "bullet" }],
					["table"], // æ·»åŠ è¡¨æ ¼æŒ‰é’®
					["export"], // ç»Ÿä¸€çš„å¯¼å‡ºæŒ‰é’®
				],
				handlers: {
					undo: function () {
						quill.history.undo();
					},
					redo: function () {
						quill.history.redo();
					},
					export: function (value) {
						showExportMenu();
					},
					table: function (value) {
						table.insertTable(3, 3);
					},
				},
			},
			history: {
				delay: 1000,
				maxStack: 500,
				//trueè¡¨ç¤ºåªæœ‰ç”¨æˆ·æ“ä½œæ‰ä¼šè¢«è®°å½•ï¼Œfalseè¡¨ç¤ºæ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«è®°å½•
				userOnly: false,
			},
		},

		placeholder: "Compose an epic...",
		theme: "snow",
	};
	const quill = new Quill("#editor", options);
	const table = quill.getModule("table");

	let currentRange = null;

	const floatingInput = document.getElementById("floatingInput");
	const promptInput = document.getElementById("promptInput");
	const sendBtn = document.getElementById("sendBtn");
	const aiResponse = document.getElementById("aiResponse");
	const actionButtons = document.getElementById("actionButtons");

	// é€‰ä¸­å†…å®¹éƒ¨åˆ†çš„é«˜äº®å¤„ç†
	function highlightSelection(range) {
		if (range && range.length > 0) {
			quill.formatText(range.index, range.length, "background", "#b4d5fe");
		}
	}

	function clearHighlight() {
		if (currentRange) {
			quill.formatText(
				currentRange.index,
				currentRange.length,
				"background",
				false
			);
		}
	}

	/**
	 * å¤„ç† Quill ç¼–è¾‘å™¨ä¸­çš„é€‰æ‹©å˜åŒ–äº‹ä»¶
	 *
	 * @param {Object} range - å½“å‰é€‰æ‹©çš„èŒƒå›´å¯¹è±¡ï¼Œ{index, length}ã€‚
	 * @param {Object} oldRange - ä¹‹å‰çš„é€‰æ‹©èŒƒå›´å¯¹è±¡ã€‚
	 * @param {string} source - è§¦å‘é€‰æ‹©å˜åŒ–çš„æ¥æºï¼Œä¾‹å¦‚ 'user' æˆ– 'api'ã€‚
	 * é€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œåœ¨é€‰ä¸­æ–‡æœ¬æ—¶quillå†…éƒ¨emitå¯¹åº”çš„æ—¶é—´åçš„å›è°ƒ
	 */
	quill.on("selection-change", function (range, oldRange, source) {
		console.log("ğŸš€ ~ range:", range);
		if (range && range.length > 0) {
			//é€‰ä¸­å†…å®¹åï¼Œç»§ç»­é€‰ä¸­æ–°çš„å†…å®¹æ—¶ï¼Œæ¸…é™¤ä¹‹å‰é€‰ä¸­å†…å®¹çš„é«˜äº®
			if (currentRange) clearHighlight();

			//getBounds() æ–¹æ³•ç”¨äºè·å–æ–‡æœ¬é€‰åŒºçš„ä½ç½®å’Œå°ºå¯¸ä¿¡æ¯,ç›¸å¯¹äºå·¦ä¸Šè§’åŸç‚¹
			const bounds = quill.getBounds(range.index, range.length);
			currentRange = range;

			// æ·»åŠ é«˜äº®
			highlightSelection(range);

			// è·å–ç¼–è¾‘å™¨å®¹å™¨çš„ä½ç½®ä¿¡æ¯
			const editorRect = quill.container.getBoundingClientRect();

			// è®¡ç®—è¾“å…¥æ¡†çš„ä½ç½®
			//é¡¶éƒ¨ä½ç½® = ç¼–è¾‘å™¨å®¹å™¨çš„é¡¶éƒ¨è·ç¦»è§†å£é¡¶éƒ¨ + é€‰ä¸­æ–‡æœ¬çš„åº•éƒ¨è·ç¦»ç¼–è¾‘å®¹å™¨é¡¶éƒ¨ + 10px
			const topPosition = editorRect.top + bounds.bottom + 10; // åœ¨é€‰ä¸­æ–‡æœ¬ä¸‹æ–¹10px
			const leftPosition = editorRect.left + bounds.left;

			floatingInput.style.display = "block";
			floatingInput.style.top = `${topPosition}px`;
			floatingInput.style.left = `${leftPosition}px`;

			// è®¾ç½®å‚ç›´èœå•çš„ä½ç½®ï¼Œåœ¨å¯¹è¯æ¡†ä¸‹æ–¹
			const verticalMenu = document.getElementById("verticalMenu");
			verticalMenu.style.display = "block";
			verticalMenu.style.top = `${
				topPosition + floatingInput.offsetHeight + 10
			}px`;
			verticalMenu.style.left = `${leftPosition}px`;
		} else if (!range) {
			console.log("ğŸš€ ~ !range:", !range);
			// ç‚¹å‡»ç¼–è¾‘å™¨å¤–éƒ¨æ—¶éšè—è¾“å…¥æ¡†ï¼Œä½†ç‚¹å‡»è¾“å…¥æ¡†æœ¬èº«æ—¶ä¸éšè—
			if (!floatingInput.contains(document.activeElement)) {
				clearHighlight();
				floatingInput.style.display = "none";
				const verticalMenu = document.getElementById("verticalMenu");
				verticalMenu.style.display = "none"; // éšè—èœå•
			}
		}
	});

	// å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	sendBtn.addEventListener("click", async () => {
		const prompt = promptInput.value;
		if (!prompt) return;

		// è·å–é€‰ä¸­çš„æ–‡æœ¬
		const selectedText = currentRange
			? quill.getText(currentRange.index, currentRange.length)
			: "";

		// æ¨¡æ‹ŸAIå“åº”
		aiResponse.style.display = "block";
		aiResponse.textContent = "æ­£åœ¨ç”Ÿæˆå›ç­”...";

		// æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
		setTimeout(() => {
			aiResponse.textContent = `é€‰ä¸­çš„æ–‡æœ¬æ˜¯ï¼š${selectedText}  AIçš„å›ç­”ï¼š${prompt}`;
			actionButtons.style.display = "flex";
		}, 1000);
	});

	// æ·»åŠ æ¸è¿›å¼æ’å…¥æ–‡æœ¬çš„å‡½æ•°
	async function progressiveInsert(text, startIndex, isReplace = false) {
		const delay = 50; // æ¯ä¸ªå­—ç¬¦æ’å…¥çš„å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

		if (isReplace) {
			clearHighlight();
			quill.deleteText(currentRange.index, currentRange.length);
		}

		const insertPosition = isReplace ? currentRange.index : startIndex;
		let currentPosition = insertPosition;

		for (let i = 0; i < text.length; i++) {
			await new Promise((resolve) => setTimeout(resolve, delay));
			quill.insertText(currentPosition, text[i]);
			currentPosition++;
		}
		return Promise.resolve();
	}

	// æ’å…¥å†…å®¹çš„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	document.getElementById("insertAfter").addEventListener("click", () => {
		if (currentRange && aiResponse.textContent) {
			const insertIndex = currentRange.index + currentRange.length;
			progressiveInsert(" " + aiResponse.textContent, insertIndex).then(() => {
				clearHighlight();
			});
		}
	});

	// æ›¿æ¢å†…å®¹çš„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	document.getElementById("replace").addEventListener("click", () => {
		if (currentRange && aiResponse.textContent) {
			progressiveInsert(aiResponse.textContent, currentRange.index, true).then(
				() => {
					clearHighlight();
				}
			);
		}
	});

	// ç§»é™¤åŸæœ‰çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œæ”¹ç”¨æ–°çš„é€»è¾‘
	document.addEventListener("mouseup", (event) => {
		// å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿selection-changeäº‹ä»¶å…ˆè§¦å‘
		setTimeout(() => {
			const target = event.target;
			const verticalMenu = document.getElementById("verticalMenu");
			const isInVerticalMenu = verticalMenu.contains(target);
			// æ£€æŸ¥ç‚¹å‡»ç›®æ ‡æ˜¯å¦åœ¨å…è®¸çš„åŒºåŸŸå†…
			const isInFloatingInput = floatingInput.contains(target);
			const isInEditor = quill.container.contains(target);
			const hasSelection =
				quill.getSelection() && quill.getSelection().length > 0;

			/* 			console.log(
				"toolbarContainers > target",
				toolbarContainer.contains(target)
			); */

			// å¦‚æœç‚¹å‡»åœ¨å…è®¸åŒºåŸŸå¤–ï¼Œä¸”ä¸æ˜¯åœ¨é€‰æ‹©æ–‡æœ¬
			if (!isInFloatingInput && !hasSelection && !isInVerticalMenu) {
				floatingInput.style.display = "none";
				aiResponse.style.display = "none";
				actionButtons.style.display = "none";
				verticalMenu.style.display = "none"; // éšè—èœå•
				promptInput.value = "";
				clearHighlight(); // æ¸…é™¤é«˜äº®
			}
		}, 0);
	});

	// é€‰ä¸­åçš„aièœå•é¡¹ç‚¹å‡»äº‹ä»¶
	document.querySelectorAll(".menu-item").forEach((item) => {
		item.addEventListener("click", function () {
			const actionText = this.textContent.trim();
			promptInput.value = actionText;
			sendBtn.click();
			verticalMenu.style.display = "none"; // éšè—èœå•
		});
	});

	// æ˜¾ç¤ºå¯¼å‡ºèœå•
	function showExportMenu() {
		const exportMenu = document.getElementById("exportMenu");
		const toolbarButton = document.querySelector(".ql-export");
		const rect = toolbarButton.getBoundingClientRect();

		exportMenu.style.display = "block";
		exportMenu.style.top = `${rect.bottom + window.scrollY}px`;
		exportMenu.style.left = `${rect.left}px`;
	}

	// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å¯¼å‡ºèœå•
	document.addEventListener("click", function (e) {
		const exportMenu = document.getElementById("exportMenu");
		const exportButton = document.querySelector(".ql-export");
		if (!exportMenu.contains(e.target) && !exportButton.contains(e.target)) {
			exportMenu.style.display = "none";
		}
	});

	// markdownå¯¼å‡ºåŠŸèƒ½
	function exportToMarkdown() {
		// åˆ›å»º TurndownService å®ä¾‹
		const turndownService = new TurndownService({
			headingStyle: "atx",
			codeBlock: "```",
			emDelimiter: "_",
		});

		// æ·»åŠ è¡¨æ ¼è½¬æ¢è§„åˆ™
		turndownService.addRule("table", {
			filter: "table",
			replacement: function (content, node) {
				// å¤„ç†è¡¨æ ¼å†…å®¹
				const rows = node.querySelectorAll("tr");
				let markdownTable = "";

				// å¤„ç†è¡¨å¤´
				const headerRow = rows[0];
				const headers = headerRow.querySelectorAll("th, td");
				markdownTable +=
					"| " +
					Array.from(headers)
						.map((header) => turndownService.turndown(header.innerHTML.trim()))
						.join(" | ") +
					" |\n";

				// å¤„ç†è¡¨å¤´åˆ†éš”çº¿
				markdownTable +=
					"| " +
					Array.from(headers)
						.map(() => "---")
						.join(" | ") +
					" |\n";

				// å¤„ç†è¡¨æ ¼æ•°æ®è¡Œ
				for (let i = 1; i < rows.length; i++) {
					const cells = rows[i].querySelectorAll("td");
					markdownTable +=
						"| " +
						Array.from(cells)
							.map((cell) => turndownService.turndown(cell.innerHTML.trim()))
							.join(" | ") +
						" |\n";
				}

				return markdownTable;
			},
		});

		// è·å–ç¼–è¾‘å™¨å†…å®¹
		const htmlContent = quill.root.innerHTML;

		// è½¬æ¢ä¸º Markdown
		const markdownContent = turndownService.turndown(htmlContent);
		console.log("ğŸš€ ~ exportToMarkdown ~ markdownContent:", markdownContent);

		// åˆ›å»º Blob
		const blob = new Blob([markdownContent], { type: "text/markdown" });

		// åˆ›å»ºä¸‹è½½é“¾æ¥
		const url = window.URL.createObjectURL(blob);
		const a = document.createElement("a");
		a.href = url;
		a.download = "document.md";

		// è§¦å‘ä¸‹è½½
		document.body.appendChild(a);
		a.click();

		// æ¸…ç†
		window.URL.revokeObjectURL(url);
		document.body.removeChild(a);
	}

	// æ·»åŠ å¯¼å‡ºåŠŸèƒ½
	document.querySelectorAll(".export-menu-item").forEach((item) => {
		item.addEventListener("click", function () {
			const format = this.dataset.format;
			switch (format) {
				case "markdown":
					exportToMarkdown();
					break;
				case "docx":
					exportToWord();
					break;
				case "pdf":
					exportToPDF();
					break;
			}
			document.getElementById("exportMenu").style.display = "none";
		});
	});

	// æ›´æ–° Word å¯¼å‡ºåŠŸèƒ½
	function htmlTableToDocxTable(htmlTable) {
		const rows = [];
		htmlTable.querySelectorAll("tr").forEach((tr) => {
			const cells = [];
			tr.querySelectorAll("th, td").forEach((td) => {
				const paragraph = new docx.Paragraph({
					children: [new docx.TextRun(td.textContent)],
				});
				cells.push(new docx.TableCell({ children: [paragraph] }));
			});

			// è®¾ç½®è¡Œé«˜
			rows.push(
				new docx.TableRow({
					children: cells,
					height: {
						value: 800, // è¡Œé«˜å€¼ï¼ˆå•ä½ä¸º dxaï¼Œ1/20 ç£…ï¼‰
						rule: docx.HeightRule.ATLEAST, // è¡Œé«˜è§„åˆ™
					},
				})
			);
		});

		// è®¾ç½®è¡¨æ ¼å®½åº¦å’Œåˆ—å®½
		return new docx.Table({
			rows,
			width: {
				size: 100, // è¡¨æ ¼å®½åº¦ä¸º 100%
				type: docx.WidthType.PERCENTAGE,
			},
			columnWidths: [3000, 3000], // æ¯åˆ—å®½åº¦ï¼ˆå•ä½ä¸º dxaï¼‰
		});
	}

	// å°† HTML å†…å®¹è½¬æ¢ä¸º docx æ®µè½
	function htmlToDocxParagraphs(element) {
		const paragraphs = [];
		element.childNodes.forEach((node) => {
			if (node.nodeType === Node.TEXT_NODE) {
				// å¤„ç†æ–‡æœ¬èŠ‚ç‚¹
				if (node.textContent.trim()) {
					paragraphs.push(
						new docx.Paragraph({
							children: [new docx.TextRun(node.textContent)],
						})
					);
				}
			} else if (node.nodeType === Node.ELEMENT_NODE) {
				// å¤„ç†å…ƒç´ èŠ‚ç‚¹
				if (node.tagName === "P") {
					// æ®µè½
					paragraphs.push(
						new docx.Paragraph({
							children: [new docx.TextRun(node.textContent)],
						})
					);
				} else if (node.tagName === "TABLE") {
					// è¡¨æ ¼
					paragraphs.push(htmlTableToDocxTable(node));
				} else if (node.tagName === "STRONG" || node.tagName === "B") {
					// åŠ ç²—æ–‡æœ¬
					paragraphs.push(
						new docx.Paragraph({
							children: [
								new docx.TextRun({ text: node.textContent, bold: true }),
							],
						})
					);
				} else if (node.tagName === "EM" || node.tagName === "I") {
					// æ–œä½“æ–‡æœ¬
					paragraphs.push(
						new docx.Paragraph({
							children: [
								new docx.TextRun({ text: node.textContent, italics: true }),
							],
						})
					);
				} else {
					// å…¶ä»–å…ƒç´ ï¼ˆå¦‚ divã€span ç­‰ï¼‰
					paragraphs.push(
						new docx.Paragraph({
							children: [new docx.TextRun(node.textContent)],
						})
					);
				}
			}
		});
		return paragraphs;
	}

	// å¯¼å‡ºä¸º Word æ–‡æ¡£
	async function exportToWord() {
		try {
			const element = quill.root; // è·å– Quill çš„æ ¹ DOM å…ƒç´ 

			// å°† HTML å†…å®¹è½¬æ¢ä¸º docx æ®µè½
			const paragraphs = htmlToDocxParagraphs(element);

			// åˆ›å»º Word æ–‡æ¡£
			const docDocument = new docx.Document({
				sections: [
					{
						properties: {},
						children: paragraphs, // æ·»åŠ æ®µè½å’Œè¡¨æ ¼
					},
				],
			});

			// ç”Ÿæˆå¹¶ä¸‹è½½ Word æ–‡ä»¶
			const blob = await docx.Packer.toBlob(docDocument);
			const url = window.URL.createObjectURL(blob);
			const a = document.createElement("a");
			a.href = url;
			a.download = "export.docx";
			a.click();
			window.URL.revokeObjectURL(url);
		} catch (error) {
			console.error("Export to Word failed:", error);
		}
	}

	// PDFå¯¼å‡ºåŠŸèƒ½
	function exportToPDF() {
		const element = quill.root;
		const opt = {
			margin: 1,
			filename: "document.pdf",
			html2canvas: { scale: 2 },
			jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
		};

		html2pdf().set(opt).from(element).save();
	}

	// ä¿®æ”¹ Markdown æ¸²æŸ“åŠŸèƒ½
	function renderMarkdown(markdownText) {
		try {
			const md = window
				.markdownit({
					html: true,
					breaks: true,
					linkify: true,
				})
				.use(function (md) {
					// è‡ªå®šä¹‰è¡¨æ ¼å’Œä»£ç å—æ¸²æŸ“
					// å®Œå…¨è¦†ç›–è¡¨æ ¼æ¸²æŸ“è§„åˆ™
					md.renderer.rules.table_open = () => "<table><tbody>";
					md.renderer.rules.table_close = () => "</tbody></table>";
					md.renderer.rules.tr_open = () => "<tr>";
					md.renderer.rules.th_open = () => '<td data-header="true">'; // ç”¨ td ä½†æ ‡è®°ä¸º header

					// ä¿®æ”¹ä»£ç å—æ¸²æŸ“è§„åˆ™ï¼ˆcode_block å’Œ fenceï¼‰
					md.renderer.rules.code_block = function (tokens, idx) {
						//ä»£ç å—çš„æ ¼å¼æ”¯æŒ
						/* return (
							// "<pre><code>" +
							md.utils.escapeHtml(tokens[idx].content) + "\n"
							// "</code></pre>\n"
						); */
						return md.utils.escapeHtml(tokens[idx].content) + "\n";
					};

					md.renderer.rules.fence = function (tokens, idx) {
						return md.utils.escapeHtml(tokens[idx].content) + "\n";
					};
				});

			const html = md
				.render(markdownText)
				.replace(/<th>/g, '<td data-header="true">') // æ›¿æ¢ th ä¸ºæ ‡è®°çš„ td
				.replace(/<\/th>/g, "</td>");
			console.log("ğŸš€ ~ renderMarkdown ~ html:", html);
			// è·å–å½“å‰å…‰æ ‡ä½ç½®
			const currentSelection = quill.getSelection();
			let cursorPosition = currentSelection
				? currentSelection.index
				: quill.getLength();

			// åœ¨å…‰æ ‡ä½ç½®æ’å…¥ HTML
			quill.clipboard.dangerouslyPasteHTML(cursorPosition, html);

			// è®¡ç®—æ–°å…‰æ ‡ä½ç½®ï¼ˆæ’å…¥å†…å®¹çš„é•¿åº¦ï¼‰
			const delta = quill.clipboard.convert(html);
			const insertedLength = delta.reduce(
				(acc, op) => acc + (op.insert ? op.insert.length || 1 : 0),
				0
			);

			// ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥å†…å®¹æœ«å°¾
			quill.setSelection(cursorPosition + insertedLength, 0);
		} catch (error) {
			console.error("Markdown rendering failed:", error);
		}
	}

	// æµ‹è¯•ç”¨çš„ Markdown æ–‡æœ¬
	const testMarkdown = `# è¿™æ˜¯ä¸€ä¸ªæ ‡é¢˜

è¿™æ˜¯ä¸€æ®µæ™®é€šæ–‡æœ¬ï¼ŒåŒ…å«**ç²—ä½“**å’Œ*æ–œä½“*ã€‚

## åˆ—è¡¨ç¤ºä¾‹
- é¡¹ç›® 1
- é¡¹ç›® 2
  - å­é¡¹ç›® A
  - å­é¡¹ç›® B

## ä»£ç ç¤ºä¾‹
\`\`\`javascript
function hello() {
    console.log("Hello, World!");
}
\`\`\`

## è¡¨æ ¼ç¤ºä¾‹
| åˆ—1 | åˆ—2 | åˆ—3 |
|-----|-----|-----|
| A1  | B1  | C1  |
| A2  | B2  | C2  |
`;

	// æµ‹è¯•æ¸²æŸ“å‡½æ•°
	function testMarkdownRender() {
		renderMarkdown(testMarkdown);
	}
</script>
