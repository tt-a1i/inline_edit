<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<link
	href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css"
	rel="stylesheet"
/>
<!-- <script
	src="https://cdnjs.cloudflare.com/ajax/libs/quill/2.0.0-dev.3/quill.min.js"
	type="text/javascript"
></script> -->
<script
	src="https://unpkg.com/quill-table-ui@1.0.5/dist/umd/index.js"
	type="text/javascript"
></script>
<!-- <link
	href="https://cdnjs.cloudflare.com/ajax/libs/quill/2.0.0-dev.3/quill.snow.min.css"
	rel="stylesheet"
/> -->
<link
	href="https://unpkg.com/quill-table-ui@1.0.5/dist/index.css"
	rel="stylesheet"
/>
<!-- 在其他 script 标签后添加 Turndown -->
<script src="https://unpkg.com/turndown/dist/turndown.js"></script>
<script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- 添加 Font Awesome 图标库 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
	/* 确保工具栏是 flex 布局，并且新按钮会被放置在末尾 */
	.ql-toolbar {
		display: flex;
		justify-content: flex-start; /* 确保按钮按照顺序排列 */
		flex-wrap: wrap;
	}

	.editor-container {
		max-width: 800px;
		margin: 0 auto;
		padding: 20px;
	}

	.ql-container .ql-editor::selection,
	.ql-container .ql-editor *::selection {
		background-color: #b4d5fe;
	}

	.floating-input {
		position: fixed; /* 改为 fixed 定位 */
		display: none;
		background: white;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		border-radius: 8px;
		padding: 10px;
		width: 300px;
		z-index: 9999;
	}

	.input-container {
		display: flex;
		gap: 8px;
		margin-bottom: 10px;
	}

	.input-container input {
		flex: 1;
		padding: 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
	}

	.send-btn {
		background: #409eff;
		border: none;
		border-radius: 4px;
		padding: 8px;
		color: white;
		cursor: pointer;
	}

	.ai-response {
		background: #f5f5f5;
		padding: 10px;
		border-radius: 4px;
		margin-top: 10px;
		display: none;
	}

	.action-buttons {
		display: none;
		gap: 8px;
		margin-top: 8px;
	}

	.action-buttons button {
		padding: 4px 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
		cursor: pointer;
	}

	.highlight-selection {
		background-color: #b4d5fe !important;
	}

	/* 添加垂直菜单样式 */
	.vertical-menu {
		position: fixed;
		display: none;
		background: white;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		border-radius: 8px;
		width: 300px;
		z-index: 9998;
	}

	.menu-item {
		padding: 10px 15px;
		cursor: pointer;
		transition: background-color 0.2s;
	}

	.menu-item:hover {
		background-color: #f5f5f5;
	}

	.menu-item + .menu-item {
		border-top: 1px solid #eee;
	}

	.ql-customButton::before {
		font-family: "Font Awesome 5 Free";
		content: "\f1c5"; /* 表格图标的 Unicode */
		margin-right: 8px;
	}

	.ql-exportMd::before {
		font-family: "Font Awesome 5 Free";
		content: "\f56d"; /* Markdown icon */
		margin-right: 8px;
	}

	.export-menu {
		position: absolute;
		display: none;
		background: white;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		border-radius: 4px;
		z-index: 1000;
	}

	.export-menu-item {
		padding: 8px 16px;
		cursor: pointer;
		white-space: nowrap;
	}

	.export-menu-item:hover {
		background-color: #f5f5f5;
	}

	.export-menu-item + .export-menu-item {
		border-top: 1px solid #eee;
	}

	/* 添加导出按钮样式 */
	.ql-export {
		position: relative;
		width: 28px;
		height: 24px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.ql-export::before {
		font-family: "Font Awesome 5 Free";
		content: "\f56e"; /* 导出图标的 Unicode */
		font-weight: 900;
		font-size: 14px;
	}

	/* 可选：添加悬停效果 */
	.ql-export:hover {
		color: #06c;
	}

	/* 修改表格按钮样式 */
	.ql-table {
		position: relative;
		width: 28px;
		height: 24px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.ql-table:hover {
		color: #06c;
	}
</style>

<div class="editor-container">
	<div id="editor">
		<h2>Demo Content</h2>
		<p>Preset build with <code>snow</code> theme, and some common formats.</p>
	</div>
</div>

<div class="floating-input" id="floatingInput">
	<div class="input-container">
		<input type="text" id="promptInput" placeholder="输入提示..." />
		<button class="send-btn" id="sendBtn">✈️</button>
	</div>
	<div class="ai-response" id="aiResponse"></div>
	<div class="action-buttons" id="actionButtons">
		<button id="insertAfter">插入到后面</button>
		<button id="replace">替换选中内容</button>
	</div>
</div>

<!-- 垂直菜单HTML结构 -->
<div class="vertical-menu" id="verticalMenu">
	<div class="menu-item">✍️ 改写这段内容</div>
	<div class="menu-item">🔄 生成相似内容</div>
	<div class="menu-item">📝 总结这段内容</div>
	<div class="menu-item">🎯 优化这段内容</div>
</div>

<!-- 在 editor-container div 后添加导出菜单 -->
<div class="export-menu" id="exportMenu">
	<div class="export-menu-item" data-format="markdown">导出为 Markdown</div>
	<div class="export-menu-item" data-format="docx">导出为 Word</div>
	<div class="export-menu-item" data-format="pdf">导出为 PDF</div>
</div>

<script>
	Quill.register("modules/tableUI", quillTableUI.default);

	const options = {
		// debug: "info",
		modules: {
			table: true,
			tableUI: true,
			toolbar: {
				container: [
					[{ header: [1, 2, false] }],
					["bold", "italic", "underline"],
					["image", "code-block"],
					[{ list: 'ordered' }, { list: 'bullet' }],
					["table"], // 添加表格按钮
					["export"], // 统一的导出按钮
				],
				handlers: {
					export: function(value) {
						showExportMenu();
					},
					table: function(value) {
						table.insertTable(3, 3);
					}
				}
			},
		},

		placeholder: "Compose an epic...",
		theme: "snow",
	};
	const quill = new Quill("#editor", options);
	const table = quill.getModule("table");

	let currentRange = null;

	const floatingInput = document.getElementById("floatingInput");
	const promptInput = document.getElementById("promptInput");
	const sendBtn = document.getElementById("sendBtn");
	const aiResponse = document.getElementById("aiResponse");
	const actionButtons = document.getElementById("actionButtons");

	// document
	// 	.querySelector(".ql-customButton")
	// 	.addEventListener("click", function () {
	// 		table.insertTable(3, 3);
	// 	});

	// 选中内容部分的高亮处理
	function highlightSelection(range) {
		if (range && range.length > 0) {
			quill.formatText(range.index, range.length, "background", "#b4d5fe");
		}
	}

	function clearHighlight() {
		if (currentRange) {
			quill.formatText(
				currentRange.index,
				currentRange.length,
				"background",
				false
			);
		}
	}

	/**
	 * 处理 Quill 编辑器中的选择变化事件
	 *
	 * @param {Object} range - 当前选择的范围对象，{index, length}。
	 * @param {Object} oldRange - 之前的选择范围对象。
	 * @param {string} source - 触发选择变化的来源，例如 'user' 或 'api'。
	 * 通过发布订阅模式，在选中文本时quill内部emit对应的时间名的回调
	 */
	quill.on("selection-change", function (range, oldRange, source) {
		console.log("🚀 ~ range:", range);
		if (range && range.length > 0) {
			//选中内容后，继续选中新的内容时，清除之前选中内容的高亮
			if (currentRange) clearHighlight();

			//getBounds() 方法用于获取文本选区的位置和尺寸信息,相对于左上角原点
			const bounds = quill.getBounds(range.index, range.length);
			currentRange = range;

			// 添加高亮
			highlightSelection(range);

			// 获取编辑器容器的位置信息
			const editorRect = quill.container.getBoundingClientRect();

			// 计算输入框的位置
			//顶部位置 = 编辑器容器的顶部距离视口顶部 + 选中文本的底部距离编辑容器顶部 + 10px
			const topPosition = editorRect.top + bounds.bottom + 10; // 在选中文本下方10px
			const leftPosition = editorRect.left + bounds.left;

			floatingInput.style.display = "block";
			floatingInput.style.top = `${topPosition}px`;
			floatingInput.style.left = `${leftPosition}px`;

			// 设置垂直菜单的位置，在对话框下方
			const verticalMenu = document.getElementById("verticalMenu");
			verticalMenu.style.display = "block";
			verticalMenu.style.top = `${
				topPosition + floatingInput.offsetHeight + 10
			}px`;
			verticalMenu.style.left = `${leftPosition}px`;
		} else if (!range) {
			console.log("🚀 ~ !range:", !range);
			// 点击编辑器外部时隐藏输入框，但点击输入框本身时不隐藏
			if (!floatingInput.contains(document.activeElement)) {
				clearHighlight();
				floatingInput.style.display = "none";
				const verticalMenu = document.getElementById("verticalMenu");
				verticalMenu.style.display = "none"; // 隐藏菜单
			}
		}
	});

	// 发送按钮点击事件
	sendBtn.addEventListener("click", async () => {
		const prompt = promptInput.value;
		if (!prompt) return;

		// 获取选中的文本
		const selectedText = currentRange
			? quill.getText(currentRange.index, currentRange.length)
			: "";

		// 模拟AI响应
		aiResponse.style.display = "block";
		aiResponse.textContent = "正在生成回答...";

		// 模拟API调用延迟
		setTimeout(() => {
			aiResponse.textContent = `选中的文本是：${selectedText}  AI的回答：${prompt}`;
			actionButtons.style.display = "flex";
		}, 1000);
	});

	// 添加渐进式插入文本的函数
	async function progressiveInsert(text, startIndex, isReplace = false) {
		const delay = 50; // 每个字符插入的延迟时间（毫秒）

		if (isReplace) {
			clearHighlight();
			quill.deleteText(currentRange.index, currentRange.length);
		}

		const insertPosition = isReplace ? currentRange.index : startIndex;
		let currentPosition = insertPosition;

		for (let i = 0; i < text.length; i++) {
			await new Promise((resolve) => setTimeout(resolve, delay));
			quill.insertText(currentPosition, text[i]);
			currentPosition++;
		}
		return Promise.resolve();
	}

	// 插入内容的按钮点击事件
	document.getElementById("insertAfter").addEventListener("click", () => {
		if (currentRange && aiResponse.textContent) {
			const insertIndex = currentRange.index + currentRange.length;
			progressiveInsert(" " + aiResponse.textContent, insertIndex).then(() => {
				clearHighlight();
			});
		}
	});

	// 替换内容的按钮点击事件
	document.getElementById("replace").addEventListener("click", () => {
		if (currentRange && aiResponse.textContent) {
			progressiveInsert(aiResponse.textContent, currentRange.index, true).then(
				() => {
					clearHighlight();
				}
			);
		}
	});

	// 移除原有的点击事件监听器，改用新的逻辑
	document.addEventListener("mouseup", (event) => {
		// 延迟执行以确保selection-change事件先触发
		setTimeout(() => {
			const target = event.target;
			const verticalMenu = document.getElementById("verticalMenu");
			const isInVerticalMenu = verticalMenu.contains(target);
			// 检查点击目标是否在允许的区域内
			const isInFloatingInput = floatingInput.contains(target);
			const isInEditor = quill.container.contains(target);
			const hasSelection =
				quill.getSelection() && quill.getSelection().length > 0;

			/* 			console.log(
				"toolbarContainers > target",
				toolbarContainer.contains(target)
			); */

			// 如果点击在允许区域外，且不是在选择文本
			if (!isInFloatingInput && !hasSelection && !isInVerticalMenu) {
				floatingInput.style.display = "none";
				aiResponse.style.display = "none";
				actionButtons.style.display = "none";
				verticalMenu.style.display = "none"; // 隐藏菜单
				promptInput.value = "";
				clearHighlight(); // 清除高亮
			}
		}, 0);
	});

	// 添加菜单项点击事件
	document.querySelectorAll(".menu-item").forEach((item) => {
		item.addEventListener("click", function () {
			const actionText = this.textContent.trim();
			promptInput.value = actionText;
			sendBtn.click();
			verticalMenu.style.display = "none"; // 隐藏菜单
		});
	});

	// 在 CustomButton 定义后添加
	function exportToMarkdown() {
		// 创建 TurndownService 实例
		const turndownService = new TurndownService({
			headingStyle: 'atx',
			codeBlock: '```',
			emDelimiter: '_'
		});

		// 获取编辑器内容
		const htmlContent = quill.root.innerHTML;
		
		// 转换为 Markdown
		const markdownContent = turndownService.turndown(htmlContent);

		// 创建 Blob
		const blob = new Blob([markdownContent], { type: 'text/markdown' });
		
		// 创建下载链接
		const url = window.URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = 'document.md';
		
		// 触发下载
		document.body.appendChild(a);
		a.click();
		
		// 清理
		window.URL.revokeObjectURL(url);
		document.body.removeChild(a);
	}

	function showExportMenu() {
		const exportMenu = document.getElementById('exportMenu');
		const toolbarButton = document.querySelector('.ql-export');
		const rect = toolbarButton.getBoundingClientRect();
		
		exportMenu.style.display = 'block';
		exportMenu.style.top = `${rect.bottom + window.scrollY}px`;
		exportMenu.style.left = `${rect.left}px`;
	}

	// 添加导出功能
	document.querySelectorAll('.export-menu-item').forEach(item => {
		item.addEventListener('click', function() {
			const format = this.dataset.format;
			switch(format) {
				case 'markdown':
					exportToMarkdown();
					break;
				case 'docx':
					exportToWord();
					break;
				case 'pdf':
					exportToPDF();
					break;
			}
			document.getElementById('exportMenu').style.display = 'none';
		});
	});

	// 点击其他地方关闭导出菜单
	document.addEventListener('click', function(e) {
		const exportMenu = document.getElementById('exportMenu');
		const exportButton = document.querySelector('.ql-export');
		if (!exportMenu.contains(e.target) && !exportButton.contains(e.target)) {
			exportMenu.style.display = 'none';
		}
	});

	// 添加解析富文本的辅助函数
	function parseQuillDelta() {
		const delta = quill.getContents();
		const paragraphs = [];
		let currentParagraph = {
			children: []
		};

		delta.ops.forEach(op => {
			if (op.insert && typeof op.insert === 'string') {
				// 创建文本运行对象
				const textRun = new window.docx.TextRun({
					text: op.insert,
					bold: op.attributes?.bold || false,
					italics: op.attributes?.italic || false,
					underline: op.attributes?.underline ? {} : undefined,
					size: op.attributes?.size ? parseInt(op.attributes.size) * 2 : 24,
				});

				// 处理段落换行
				if (op.insert.includes('\n')) {
					const texts = op.insert.split('\n');
					texts.forEach((text, index) => {
						if (text) {
							currentParagraph.children.push(new window.docx.TextRun({
								text: text,
								bold: op.attributes?.bold || false,
								italics: op.attributes?.italic || false,
								underline: op.attributes?.underline ? {} : undefined,
							}));
						}
						if (index < texts.length - 1) {
							// 添加当前段落并创建新段落
							paragraphs.push(new window.docx.Paragraph(currentParagraph));
							currentParagraph = {
								children: []
							};
						}
					});
				} else {
					currentParagraph.children.push(textRun);
				}
			}
		});

		// 添加最后一个段落
		if (currentParagraph.children.length > 0) {
			paragraphs.push(new window.docx.Paragraph(currentParagraph));
		}

		return paragraphs;
	}

	// 更新 Word 导出功能
	async function exportToWord() {
		try {
			// 解析富文本内容
			const paragraphs = parseQuillDelta();

			// 创建文档
			const docDocument = new window.docx.Document({
				sections: [{
					properties: {},
					children: paragraphs
				}],
			});

			// 生成文档
			window.docx.Packer.toBlob(docDocument).then(blob => {
				const url = window.URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'document.docx';
				a.click();
				window.URL.revokeObjectURL(url);
			});
		} catch (error) {
			console.error('Export to Word failed:', error);
		}
	}

	// PDF导出功能
	function exportToPDF() {
		const element = quill.root;
		const opt = {
			margin: 1,
			filename: 'document.pdf',
			html2canvas: { scale: 2 },
			jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
		};

		html2pdf().set(opt).from(element).save();
	}
</script>
