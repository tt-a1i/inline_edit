<!DOCTYPE html>
<html>
	<head>
		<style>
			#selection-toolbar {
				background-color: #f9f9f9;
				border: 1px solid #ddd;
				padding: 5px;
				border-radius: 4px;
				display: none;
				position: absolute;
				z-index: 1000;
				box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.2);
			}
			#selection-toolbar button {
				margin: 0 5px;
			}
			.highlight {
				background-color: #ffff99;
			}
		</style>
	</head>
	<body>
		<p>
			è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡æœ¬ã€‚è¯·é€‰ä¸­éƒ¨åˆ†æ–‡æœ¬åï¼Œåœ¨å…¶ä¸Šæ–¹ä¼šå‡ºç°ä¸€ä¸ªæ‚¬æµ®çš„å·¥å…·æ ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»â€œç”Ÿæˆå†…å®¹â€æŒ‰é’®ï¼Œåœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–°çš„å†…å®¹ã€‚
		</p>
		<p>
			è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡æœ¬ã€‚è¯·é€‰ä¸­éƒ¨åˆ†æ–‡æœ¬åï¼Œåœ¨å…¶ä¸Šæ–¹ä¼šå‡ºç°ä¸€ä¸ªæ‚¬æµ®çš„å·¥å…·æ ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»â€œç”Ÿæˆå†…å®¹â€æŒ‰é’®ï¼Œåœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–°çš„å†…å®¹ã€‚
		</p>
		<p>
			è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡æœ¬ã€‚è¯·é€‰ä¸­éƒ¨åˆ†æ–‡æœ¬åï¼Œåœ¨å…¶ä¸Šæ–¹ä¼šå‡ºç°ä¸€ä¸ªæ‚¬æµ®çš„å·¥å…·æ ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»â€œç”Ÿæˆå†…å®¹â€æŒ‰é’®ï¼Œåœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–°çš„å†…å®¹ã€‚
		</p>
		<p>
			è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡æœ¬ã€‚è¯·é€‰ä¸­éƒ¨åˆ†æ–‡æœ¬åï¼Œåœ¨å…¶ä¸Šæ–¹ä¼šå‡ºç°ä¸€ä¸ªæ‚¬æµ®çš„å·¥å…·æ ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»â€œç”Ÿæˆå†…å®¹â€æŒ‰é’®ï¼Œåœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–°çš„å†…å®¹ã€‚
		</p>
		<script>
			// ç›‘å¬é¼ æ ‡å¼¹èµ·äº‹ä»¶ï¼Œæ£€æµ‹é€‰åŒº
			document.addEventListener("mouseup", function (event) {
				//è·å–å½“å‰é¡µé¢ä¸Šçš„æ–‡æœ¬é€‰æ‹©å¯¹è±¡
				const selection = window.getSelection();
				console.log("ğŸš€selection:", selection);
				//æ²¡æœ‰é€‰ä¸­å†…å®¹æ—¶ï¼ˆæ¯”å¦‚åªæ˜¯é¼ æ ‡ç‚¹å‡»ä¸€ä¸‹ï¼‰ï¼ŒisCollapsedä¸ºtrueï¼Œé€‰ä¸­å†…å®¹åä¸ºfalse
				if (!selection.isCollapsed) {
					//åˆ›å»ºrangeå¯¹è±¡çš„å‰¯æœ¬ï¼Œé¿å…ç›´æ¥å¼•ç”¨
					const range = selection.getRangeAt(0).cloneRange();
					console.log("ğŸš€ ~ document.addEventListener ~ range:", range);
					//å­˜å‚¨ä¸ºå…¨å±€å˜é‡
					window.selectedRange = range;
					showToolbar(range);
				}
			});

			// æ˜¾ç¤ºå·¥å…·æ 
			function showToolbar(range) {
				// é¿å…é‡å¤åˆ›å»º
				if (!window.selectionToolbar) {
					const toolbar = document.createElement("div");
					toolbar.id = "selection-toolbar";
					toolbar.style.display = "flex"; // ä½¿ç”¨ flex å¸ƒå±€
					toolbar.style.alignItems = "center"; // å‚ç›´å±…ä¸­
					toolbar.style.position = "absolute";
					toolbar.style.width = "100%"; // å®½åº¦ 100%
					toolbar.style.boxSizing = "border-box"; //åŒ…å«paddingå’Œborder
					toolbar.style.padding = "5px"; // æ·»åŠ å†…è¾¹è·
					toolbar.style.backgroundColor = "#f0f0f0"; // æ·»åŠ èƒŒæ™¯è‰²
					toolbar.style.border = "1px solid #ccc"; // æ·»åŠ è¾¹æ¡†

					// è¾“å…¥æ¡†
					const input = document.createElement("input");
					input.type = "text";
					input.style.flexGrow = "1"; // è¾“å…¥æ¡†å æ®å‰©ä½™ç©ºé—´
					input.style.padding = "5px";
					input.style.border = "1px solid #ccc";
					input.style.borderRadius = "3px";
					toolbar.appendChild(input);

					// å‘é€æŒ‰é’®
					const sendButton = document.createElement("button");
					sendButton.innerText = "å‘é€";
					sendButton.style.marginLeft = "5px"; // æŒ‰é’®å·¦è¾¹è·
					sendButton.style.padding = "5px 10px";
					sendButton.style.border = "1px solid #ccc";
					sendButton.style.borderRadius = "3px";
					toolbar.appendChild(sendButton);

					// ç‚¹å‡»å‘é€æŒ‰é’®çš„ç›‘å¬å™¨
					sendButton.addEventListener("click", function (e) {
						e.stopPropagation();
						const inputValue = input.value;
						// æ‰§è¡Œå‘é€æ“ä½œçš„é€»è¾‘ï¼ŒinputValue æ˜¯è¾“å…¥æ¡†ä¸­çš„å†…å®¹
						console.log("å‘é€å†…å®¹:", inputValue);
						input.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
						toolbar.style.display = "none";
					});

					document.body.appendChild(toolbar);
					window.selectionToolbar = toolbar;
				}

				const rect = range.getBoundingClientRect();
				const toolbar = window.selectionToolbar;
				const toolbarHeight = 40; // å·¥å…·æ çš„é¢„è®¡é«˜åº¦

/* 				//æ˜¾ç¤ºåœ¨ä¸Šæ–¹ï¼Œé€‰ä¸­é¡¶éƒ¨æ˜¾ç¤ºåœ¨ä¸‹æ–¹çš„åˆ¤æ–­é€»è¾‘
				// æ£€æŸ¥é€‰ä¸­æ–‡æœ¬æ˜¯å¦é è¿‘é¡µé¢é¡¶éƒ¨
				const isNearTop = rect.top < toolbarHeight + 10; // 10px ä½œä¸ºç¼“å†²åŒº

				// æ ¹æ®ä½ç½®å†³å®šå·¥å…·æ æ˜¾ç¤ºåœ¨é€‰ä¸­æ–‡æœ¬çš„ä¸Šæ–¹è¿˜æ˜¯ä¸‹æ–¹
				const topPosition = isNearTop
					? `${rect.bottom + window.pageYOffset + 5}px` // æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼ŒåŠ 5pxé—´è·
					: `${rect.top + window.pageYOffset - toolbarHeight - 5}px`; // æ˜¾ç¤ºåœ¨ä¸Šæ–¹ï¼Œå‡5pxé—´è· */

				const topPosition = `${rect.bottom + window.pageYOffset + 5}px`;
				
				toolbar.style.top = topPosition;
				toolbar.style.left = 0;
				toolbar.style.zIndex = 9999;
				toolbar.style.display = "flex";

				// å¦‚æœå·¥å…·æ åœ¨é¡¶éƒ¨ä¸”éƒ¨åˆ†ä¸å¯è§ï¼Œç¡®ä¿å…¶å¯è§
				if (isNearTop) {
					toolbar.scrollIntoView({ behavior: "smooth", block: "nearest" });
				}
			}

			// æ’å…¥æ–°å†…å®¹
			function insertGeneratedContent() {
				const range = window.selectedRange;
				if (!range) return;

				const newContent = document.createElement("span");
				newContent.innerText = "è¿™æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„å†…å®¹ã€‚";
				newContent.classList.add("highlight");

				const actionContainer = document.createElement("span");
				actionContainer.style.marginLeft = "10px";

				const acceptButton = document.createElement("button");
				acceptButton.innerText = "æ¥å—";
				acceptButton.style.marginRight = "5px";
				actionContainer.appendChild(acceptButton);

				const discardButton = document.createElement("button");
				discardButton.innerText = "ä¸¢å¼ƒ";
				actionContainer.appendChild(discardButton);

				const wrapper = document.createElement("span");
				wrapper.appendChild(newContent);
				wrapper.appendChild(actionContainer);

				range.collapse(false);
				range.insertNode(wrapper);

				wrapper.scrollIntoView({ behavior: "smooth", block: "center" });

				acceptButton.addEventListener("click", function () {
					newContent.classList.remove("highlight");
					actionContainer.remove();
				});

				discardButton.addEventListener("click", function () {
					wrapper.remove();
				});
			}

			// ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸæ—¶éšè—å·¥å…·æ 
			document.addEventListener("mousedown", function (event) {
				const toolbar = window.selectionToolbar;
				if (toolbar && !toolbar.contains(event.target)) {
					toolbar.style.display = "none";
				}
			});
		</script>
	</body>
</html>
